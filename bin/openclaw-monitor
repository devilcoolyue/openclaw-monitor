#!/bin/bash
# openclaw-monitor CLI
# Unified command-line interface for managing openclaw-monitor.

set -e

SERVICE_NAME="openclaw-monitor"

# ── Resolve project directory from symlink ────────────────
SCRIPT_PATH="$(readlink -f "$0")"
PROJECT_DIR="$(cd "$(dirname "$SCRIPT_PATH")/.." && pwd)"

# Verify project directory
if [ ! -f "$PROJECT_DIR/src/server.py" ]; then
    echo "  ERROR: Cannot find openclaw-monitor project at $PROJECT_DIR"
    exit 1
fi

# ── Help ──────────────────────────────────────────────────
show_help() {
    echo ""
    echo "  openclaw-monitor — CLI"
    echo "  ──────────────────────"
    echo ""
    echo "  Usage: openclaw-monitor <command>"
    echo ""
    echo "  Commands:"
    echo "    update      Pull latest changes and restart service"
    echo "    uninstall   Remove openclaw-monitor from this system"
    echo "    start       Start the monitor service"
    echo "    stop        Stop the monitor service"
    echo "    restart     Restart the monitor service"
    echo "    status      Show service status"
    echo "    logs        Follow service logs (Ctrl+C to stop)"
    echo "    version     Show current version"
    echo "    help        Show this help message"
    echo ""
}

# ── Dispatch subcommand ───────────────────────────────────
case "${1:-help}" in
    update)
        exec bash "$PROJECT_DIR/scripts/update.sh"
        ;;
    uninstall)
        exec bash "$PROJECT_DIR/scripts/uninstall.sh"
        ;;
    start)
        exec systemctl --user start "$SERVICE_NAME"
        ;;
    stop)
        exec systemctl --user stop "$SERVICE_NAME"
        ;;
    restart)
        exec systemctl --user restart "$SERVICE_NAME"
        ;;
    status)
        exec systemctl --user status "$SERVICE_NAME"
        ;;
    logs)
        exec journalctl --user -u "$SERVICE_NAME" -f
        ;;
    version)
        exec python3 "$PROJECT_DIR/src/server.py" --version
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo "  Unknown command: $1"
        show_help
        exit 1
        ;;
esac
