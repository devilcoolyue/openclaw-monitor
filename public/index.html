<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>openclaw monitor</title>
<style>
/* ═══════════════════════════════════════════════════════════
   Reset & Variables
   ═══════════════════════════════════════════════════════════ */
/* Dark theme (default) */
:root {
  --bg-0:#0a0e13; --bg-1:#111519; --bg-2:#161b22; --bg-3:#1c2330;
  --border:#1e2530; --border-hi:#2d3644;
  --scroll-thumb:#3a4555; --scroll-thumb-hi:#4f5d73;
  --t0:#e6edf3; --t1:#c9d1d9; --t2:#8b949e; --t3:#6e7681;
  --accent:#58a6ff; --green:#3fb950; --green2:#56d364;
  --orange:#ffa657; --purple:#bc8cff; --red:#ff7b72; --yellow:#e3b341;
}

/* Light theme */
[data-theme="light"] {
  --bg-0:#f6f8fa; --bg-1:#ffffff; --bg-2:#f0f3f6; --bg-3:#e8ebef;
  --border:#d0d7de; --border-hi:#afb8c1;
  --scroll-thumb:#afb8c1; --scroll-thumb-hi:#8c959f;
  --t0:#1f2328; --t1:#31363f; --t2:#57606a; --t3:#6e7781;
  --accent:#0969da; --green:#1a7f37; --green2:#2da44e;
  --orange:#bc4c00; --purple:#8250df; --red:#cf222e; --yellow:#9a6700;
}
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;overflow:hidden}
body{
  font-family:'SF Mono','Fira Code','JetBrains Mono','Consolas','Courier New',monospace;
  background:var(--bg-0);color:var(--t1);font-size:13px;line-height:1.5;
  display:flex;
  -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
}
a{color:inherit;text-decoration:none}

/* ═══════════════════════════════════════════════════════════
   Scrollbar
   ═══════════════════════════════════════════════════════════ */
::-webkit-scrollbar{width:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--scroll-thumb);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--scroll-thumb-hi)}

/* ═══════════════════════════════════════════════════════════
   SIDEBAR
   ═══════════════════════════════════════════════════════════ */
.sidebar{
  width:280px;min-width:280px;
  background:var(--bg-1);
  border-right:1px solid var(--border);
  display:flex;flex-direction:column;
  overflow:hidden;
}
/* header */
.sb-head{
  padding:18px 16px 12px;
  display:flex;align-items:center;justify-content:space-between;
}
.sb-logo{font-size:15px;font-weight:700;color:var(--t0);letter-spacing:-.3px}
.sb-logo em{font-style:normal;color:var(--accent)}
.live-tag{display:flex;align-items:center;gap:5px;font-size:9px;color:var(--green);text-transform:uppercase;letter-spacing:1.2px;font-weight:700}
.live-dot{width:7px;height:7px;background:var(--green);border-radius:50%;animation:pls 2s ease-in-out infinite}
@keyframes pls{0%,100%{opacity:1;box-shadow:0 0 0 0 rgba(63,185,80,.4)}50%{opacity:.8;box-shadow:0 0 0 5px rgba(63,185,80,0)}}

/* nav (Live Logs button) */
.sb-nav{padding:4px 8px 0}
.nav-btn{
  width:100%;padding:8px 10px;border-radius:6px;
  border:1px solid transparent;background:transparent;
  color:var(--t1);font-family:inherit;font-size:12px;
  cursor:pointer;text-align:left;
  display:flex;align-items:center;gap:8px;
  transition:background .15s;
}
.nav-btn:hover{background:var(--bg-3)}
.nav-btn.active{background:rgba(88,166,255,.1);border-color:rgba(88,166,255,.28);color:var(--accent)}
.nav-btn .nb-icon{font-size:14px}
.nav-btn .nb-label{flex:1}
.nav-btn .nb-badge{font-size:10px;background:var(--bg-3);padding:1px 7px;border-radius:9px;color:var(--t3)}

/* section label */
.sb-label{padding:14px 16px 4px;font-size:9px;text-transform:uppercase;letter-spacing:1.3px;color:var(--t3);font-weight:600}

/* session list */
.sb-sessions{flex:1;overflow-y:auto;padding:2px 8px 8px}
.s-card{
  padding:10px 11px;border-radius:6px;
  border:1px solid transparent;cursor:pointer;
  margin-bottom:2px;transition:background .15s;
  position:relative;
}
.s-card:hover{background:var(--bg-3)}
.s-card.active{background:rgba(88,166,255,.08);border-color:rgba(88,166,255,.25)}
.s-card-top{display:flex;align-items:center;justify-content:space-between;gap:6px}
.s-card-id{font-size:11.5px;color:var(--t0);font-weight:600;font-variant-numeric:tabular-nums;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1}
.s-card-bot{display:flex;justify-content:space-between;margin-top:4px;font-size:10px;color:var(--t3)}

/* badge */
.badge{display:inline-flex;align-items:center;gap:3px;padding:2px 7px;border-radius:9px;font-size:9px;text-transform:uppercase;letter-spacing:.6px;font-weight:600;flex-shrink:0}
.badge-proc{background:rgba(90,166,254,.13);color:#5aa6fe}
.badge-proc .bd{width:6px;height:6px;background:#5aa6fe;border-radius:50%;animation:blnk 1.4s ease-in-out infinite}
@keyframes blnk{0%,100%{opacity:1}50%{opacity:.25}}
.badge-idle{background:rgba(139,148,158,.1);color:var(--t3)}

/* heartbeat animation for processing sessions */
.s-card.processing{animation:heartbeat 2s ease-in-out infinite}
@keyframes heartbeat{
  0%,100%{background:transparent}
  50%{background:rgba(63,185,80,.1)}
}

/* footer (connection) */
.sb-foot{padding:12px 16px;border-top:1px solid var(--border);display:flex;flex-direction:column;gap:6px}
.sb-foot-row{display:flex;align-items:center;gap:8px}
.sb-foot-left{display:flex;align-items:center;gap:8px;flex:1}
.sb-foot-right{display:flex;align-items:center;gap:2px}
.sb-version{font-size:10px;color:var(--t3);opacity:.7}
.cd{width:8px;height:8px;border-radius:50%;transition:background .3s}
.cd.connected{background:var(--green)}
.cd.disconnected{background:var(--red)}
.cd.connecting{background:var(--orange);animation:blnk 1.2s infinite}
.cd-label{font-size:11px;color:var(--t3)}

/* theme toggle */
.theme-btn{
  width:28px;height:28px;border-radius:6px;
  border:1px solid transparent;background:transparent;
  color:var(--t3);font-size:14px;
  cursor:pointer;transition:all .2s;
  display:flex;align-items:center;justify-content:center;
}
.theme-btn:hover{border-color:var(--border);color:var(--accent);background:var(--bg-3)}

/* empty placeholder */
.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;min-height:180px;color:var(--t3);gap:10px}
.empty .ei{width:28px;height:28px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:boot-spin .8s linear infinite}
.empty p{font-size:12px}

/* ═══════════════════════════════════════════════════════════
   BOOT SCREEN (detection overlay)
   ═══════════════════════════════════════════════════════════ */
.boot-screen{
  position:fixed;inset:0;z-index:9998;
  background:var(--bg-0);
  display:flex;align-items:center;justify-content:center;
  transition:opacity .5s ease,visibility .5s ease;
}
.boot-screen.hidden{opacity:0;visibility:hidden;pointer-events:none}
.boot-box{
  width:420px;
  text-align:center;
  display:flex;flex-direction:column;align-items:center;gap:24px;
}
.boot-logo{font-size:20px;font-weight:700;color:var(--t0);letter-spacing:-.5px}
.boot-logo em{font-style:normal;color:var(--accent)}

/* spinner ring */
.boot-spinner{
  width:56px;height:56px;
  border:3px solid var(--border);
  border-top-color:var(--accent);
  border-radius:50%;
  animation:boot-spin 1s linear infinite;
}
.boot-spinner.ok{
  border-color:var(--green);
  border-top-color:var(--green);
  animation:boot-pop .35s ease forwards;
}
.boot-spinner.fail{
  border-color:var(--red);
  border-top-color:var(--red);
  animation:boot-pop .35s ease forwards;
}
@keyframes boot-spin{to{transform:rotate(360deg)}}
@keyframes boot-pop{
  0%{transform:scale(1)}
  50%{transform:scale(1.15)}
  100%{transform:scale(1)}
}

/* check icon inside spinner */
.boot-icon{
  width:56px;height:56px;
  display:flex;align-items:center;justify-content:center;
  font-size:28px;
  opacity:0;
  position:absolute;
  transition:opacity .3s ease;
}
.boot-icon.show{opacity:1}
.boot-spinner-wrap{position:relative;width:56px;height:56px}

/* step list */
.boot-steps{
  display:flex;flex-direction:column;gap:10px;
  width:100%;max-width:320px;text-align:left;
}
.boot-step{
  display:flex;align-items:center;gap:10px;
  font-size:12px;color:var(--t3);
  transition:color .3s ease;
}
.boot-step.active{color:var(--t1)}
.boot-step.done{color:var(--green)}
.boot-step.fail{color:var(--red)}

.boot-step-icon{
  width:22px;height:22px;
  border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-size:12px;flex-shrink:0;
  border:1.5px solid var(--border);
  background:var(--bg-2);
  transition:all .3s ease;
}
.boot-step.active .boot-step-icon{
  border-color:var(--accent);
  background:rgba(88,166,255,.1);
  animation:boot-step-pulse 1.5s ease-in-out infinite;
}
.boot-step.done .boot-step-icon{
  border-color:var(--green);
  background:rgba(63,185,80,.15);
  color:var(--green);
}
.boot-step.fail .boot-step-icon{
  border-color:var(--red);
  background:rgba(255,123,114,.1);
  color:var(--red);
}
@keyframes boot-step-pulse{
  0%,100%{box-shadow:0 0 0 0 rgba(88,166,255,.3)}
  50%{box-shadow:0 0 0 6px rgba(88,166,255,0)}
}

.boot-step-text{flex:1}
.boot-step-sub{font-size:10px;color:var(--t3);margin-top:1px}

/* progress bar under steps */
.boot-progress{
  width:100%;max-width:320px;height:3px;
  background:var(--bg-3);border-radius:2px;
  overflow:hidden;
}
.boot-progress-bar{
  height:100%;width:0%;
  background:linear-gradient(90deg,var(--accent),var(--green));
  border-radius:2px;
  transition:width .6s ease;
}
.boot-progress-bar.fail{
  background:linear-gradient(90deg,var(--accent),var(--red));
}

/* not detected state */
.boot-alert{
  display:none;flex-direction:column;align-items:center;gap:16px;
  width:100%;max-width:340px;
}
.boot-alert.show{display:flex}
.boot-alert-icon{font-size:40px;opacity:.8}
.boot-alert-title{font-size:15px;font-weight:700;color:var(--red)}
.boot-alert-desc{font-size:12px;color:var(--t2);line-height:1.6;text-align:center}
.boot-alert-hint{
  font-size:11px;color:var(--t3);
  background:var(--bg-2);border:1px solid var(--border);
  border-radius:6px;padding:12px 16px;
  text-align:left;width:100%;
  font-family:inherit;line-height:1.7;
}
.boot-alert-hint code{
  background:var(--bg-3);color:var(--orange);
  padding:1px 5px;border-radius:3px;font-size:11px;
}
.boot-retry-btn{
  padding:8px 24px;border-radius:6px;
  border:1px solid var(--accent);background:rgba(88,166,255,.1);
  color:var(--accent);font-family:inherit;font-size:12px;font-weight:600;
  cursor:pointer;transition:all .2s;
}
.boot-retry-btn:hover{background:rgba(88,166,255,.2);box-shadow:0 0 12px rgba(88,166,255,.15)}

/* detected info bar */
.boot-info{
  display:none;flex-direction:column;gap:6px;
  width:100%;max-width:320px;
  background:var(--bg-2);border:1px solid var(--border);
  border-radius:6px;padding:10px 14px;
  text-align:left;
}
.boot-info.show{display:flex}
.boot-info-row{display:flex;justify-content:space-between;font-size:11px}
.boot-info-label{color:var(--t3)}
.boot-info-val{color:var(--t0);font-weight:600}

/* scroll-to-top button */
.scroll-top-btn{
  position:absolute;bottom:24px;right:24px;
  width:36px;height:36px;border-radius:10px;
  border:1px solid var(--border-hi);
  background:var(--bg-1);color:var(--t1);
  font-size:16px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 4px 16px rgba(0,0,0,.35);
  opacity:0;visibility:hidden;
  transition:all .25s cubic-bezier(.2,.9,.3,1);
  z-index:20;
}
.scroll-top-btn.show{opacity:1;visibility:visible}
.scroll-top-btn:hover{background:var(--bg-3);border-color:var(--accent);color:var(--accent);transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,.4)}

/* toast notification */
.toast-container{position:fixed;top:16px;right:16px;z-index:9999;display:flex;flex-direction:column;gap:8px}
.toast{
  padding:10px 16px;border-radius:8px;
  background:var(--bg-1);border:1px solid var(--border-hi);
  color:var(--t1);font-size:12px;
  box-shadow:0 8px 24px rgba(0,0,0,.35),0 0 0 1px rgba(255,255,255,.04);
  animation:toast-in .25s cubic-bezier(.2,.9,.3,1);
  display:flex;align-items:center;gap:8px;
  backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);
}
.toast.error{border-color:rgba(255,123,114,.4);color:var(--red)}
.toast.success{border-color:rgba(63,185,80,.4);color:var(--green)}
@keyframes toast-in{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}
@keyframes toast-out{from{opacity:1;transform:translateX(0)}to{opacity:0;transform:translateX(20px)}}

/* language selector */
.lang-btn{
  width:28px;height:28px;border-radius:6px;
  border:1px solid transparent;background:transparent;
  color:var(--t3);font-size:10px;font-weight:700;
  cursor:pointer;transition:all .2s;
  display:flex;align-items:center;justify-content:center;
  letter-spacing:-.3px;
}
.lang-btn:hover{border-color:var(--border);color:var(--accent);background:var(--bg-3)}

/* logout button */
.logout-btn{
  width:28px;height:28px;border-radius:6px;
  border:1px solid transparent;background:transparent;
  color:var(--t3);font-size:14px;
  cursor:pointer;transition:all .2s;
  display:flex;align-items:center;justify-content:center;
}
.logout-btn:hover{border-color:var(--red);color:var(--red);background:rgba(255,123,114,.08)}

/* ═══════════════════════════════════════════════════════════
   MAIN
   ═══════════════════════════════════════════════════════════ */
.main{flex:1;min-width:0;display:flex;flex-direction:column;overflow:hidden;position:relative}

/* toolbar row */
.main-hdr{
  padding:10px 18px;
  border-bottom:1px solid var(--border);
  background:var(--bg-1);
  display:flex;align-items:center;justify-content:space-between;gap:12px;
  flex-shrink:0;
}
.mh-left{display:flex;flex-direction:column;gap:1px}
.mh-title{font-size:13px;font-weight:600;color:var(--t0)}
.mh-sub{font-size:10px;color:var(--t3)}
.mh-right{display:flex;align-items:center;gap:10px;flex-shrink:0}

/* search box */
.search-box{
  display:flex;align-items:center;gap:6px;
}
.search-input{
  width:180px;padding:4px 10px;border-radius:6px;
  border:1px solid var(--border);background:var(--bg-2);
  color:var(--t1);font-size:11px;font-family:inherit;
  outline:none;transition:all .15s;
}
.search-input::placeholder{color:var(--t3)}
.search-input:focus{border-color:var(--accent);background:var(--bg-1)}
.search-clear{
  width:20px;height:20px;border-radius:4px;
  border:none;background:transparent;
  color:var(--t3);font-size:12px;
  cursor:pointer;display:none;
  align-items:center;justify-content:center;
}
.search-clear.show{display:flex}
.search-clear:hover{background:var(--bg-3);color:var(--t1)}

/* filter pills */
.filters{display:flex;gap:4px}
.fpill{
  padding:3px 9px;border-radius:11px;
  border:1px solid var(--border);background:transparent;
  color:var(--t3);font-size:10px;font-family:inherit;
  cursor:pointer;transition:all .15s;
  text-transform:uppercase;letter-spacing:.5px;
}
.fpill:hover{border-color:var(--border-hi);color:var(--t1)}
.fpill.active{background:rgba(88,166,255,.12);border-color:rgba(88,166,255,.3);color:var(--accent)}

/* auto-scroll toggle */
.toggle-wrap{display:flex;align-items:center;gap:5px;font-size:10px;color:var(--t3)}
.tog{width:32px;height:18px;background:var(--bg-3);border-radius:9px;cursor:pointer;position:relative;border:1px solid var(--border);transition:background .2s}
.tog.on{background:var(--green);border-color:var(--green)}
.tog .knob{width:14px;height:14px;background:#fff;border-radius:50%;position:absolute;top:1px;left:1px;transition:left .2s;box-shadow:0 1px 3px rgba(0,0,0,.3)}
.tog.on .knob{left:16px}

/* clear btn */
.btn-clr{padding:3px 9px;border-radius:4px;border:1px solid var(--border);background:transparent;color:var(--t3);font-size:10px;font-family:inherit;cursor:pointer;transition:all .15s}
.btn-clr:hover{border-color:var(--red);color:var(--red)}

/* event counter */
.evt-cnt{font-size:10px;color:var(--t3);font-variant-numeric:tabular-nums;white-space:nowrap}

/* ═══════════════════════════════════════════════════════════
   SESSION SUMMARY BAR (shown when viewing a session)
   ═══════════════════════════════════════════════════════════ */
.sess-summary{
  display:flex;flex-direction:column;gap:0;
  padding:0;background:var(--bg-2);
  border-bottom:1px solid var(--border);flex-shrink:0;
}
.ss-row-top{
  display:flex;gap:20px;flex-wrap:wrap;align-items:center;
  padding:10px 18px 6px;
}
.ss-item{display:flex;flex-direction:column;gap:1px}
.ss-label{font-size:9px;text-transform:uppercase;letter-spacing:1px;color:var(--t3);font-weight:600}
.ss-val{font-size:11px;color:var(--t0);font-weight:600;font-variant-numeric:tabular-nums}
.ss-del{
  margin-left:auto;
  padding:5px 14px;border-radius:6px;
  border:1px solid var(--border);background:transparent;
  color:var(--t3);font-size:11px;font-family:inherit;
  cursor:pointer;transition:all .2s cubic-bezier(.2,.9,.3,1);
  display:flex;align-items:center;gap:6px;
}
.ss-del:hover{border-color:var(--red);color:var(--red);background:rgba(255,123,114,.08);transform:scale(1.02)}
.ss-models{
  display:flex;gap:8px;flex-wrap:wrap;
  padding:0 18px 10px;
}
.ss-model-tag{
  display:inline-flex;align-items:center;gap:6px;
  padding:4px 10px;border-radius:5px;
  background:var(--bg-3);border:1px solid var(--border);
  font-size:10.5px;color:var(--t1);
}
.ss-model-tag.current{border-color:rgba(88,166,255,.4);background:rgba(88,166,255,.08)}
.ss-model-name{font-weight:600;color:var(--t0)}
.ss-model-detail{color:var(--t3);font-variant-numeric:tabular-nums}

/* session summary toggle (hidden on desktop) */
.ss-toggle{display:none}
.ss-body{display:contents}

/* ═══════════════════════════════════════════════════════════
   STREAM AREA
   ═══════════════════════════════════════════════════════════ */
.stream{flex:1;overflow-y:auto}

/* ── Log table header ── */
.log-header{
  display:grid;grid-template-columns:80px 78px 1fr 50px;
  gap:10px;align-items:center;
  padding:6px 16px;
  background:var(--bg-2);
  border-bottom:1px solid var(--border);
  font-size:10px;font-weight:600;
  text-transform:uppercase;letter-spacing:.8px;
  color:var(--t3);
  position:sticky;top:0;z-index:10;
}

/* ── Live log row ── */
.log-row{
  display:grid;grid-template-columns:80px 78px 1fr 50px;
  gap:10px;align-items:baseline;
  padding:3px 16px;
  border-bottom:1px solid var(--border);
  font-size:11px;
  transition:background .1s;
}
.log-row:hover{background:var(--bg-2)}

/* copy button */
.lr-actions{display:flex;justify-content:center}
.copy-btn{
  width:24px;height:24px;border-radius:4px;
  border:1px solid transparent;background:transparent;
  color:var(--t3);font-size:12px;
  cursor:pointer;transition:all .15s;
  display:flex;align-items:center;justify-content:center;
  opacity:0;
}
.log-row:hover .copy-btn{opacity:1}
.copy-btn:hover{border-color:var(--border);background:var(--bg-3);color:var(--t1)}
.copy-btn.copied{color:var(--green);border-color:var(--green)}
.lr-time{color:var(--t3);font-variant-numeric:tabular-nums;flex-shrink:0}
.lr-badge{
  display:inline-block;text-align:center;
  padding:1px 5px;border-radius:3px;
  font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.4px;
}
/* badge colours */
.bt-enqueue{background:rgba(88,166,255,.15);color:#58a6ff}
.bt-dequeue{background:rgba(88,166,255,.1) ;color:#4a9beb}
.bt-run_start{background:rgba(63,185,80,.15);color:#3fb950}
.bt-run_done {background:rgba(86,211,100,.12);color:#56d364}
.bt-tool_start{background:rgba(255,166,87,.15);color:#ffa657}
.bt-tool_end  {background:rgba(210,147,67,.12);color:#d29343}
.bt-session_state{background:rgba(188,140,255,.15);color:#bc8cff}
.bt-error{background:rgba(255,123,114,.15);color:#ff7b72}
.bt-warn {background:rgba(227,179, 65,.12);color:#e3b341}
.bt-other{background:rgba(139,148,158,.1) ;color:var(--t3)}

.lr-msg{color:var(--t1);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;cursor:pointer}
.log-row.expanded{background:var(--bg-2)}
.log-row.expanded .lr-msg{white-space:pre-wrap;word-break:break-word;overflow:visible;text-overflow:clip}
/* clickable session-id links inside log messages */
.s-link{color:var(--accent);cursor:pointer}
.s-link:hover{text-decoration:underline}

/* ── Session detail blocks ── */
.s-msg{padding:10px 16px;border-bottom:1px solid var(--border)}
.s-msg:last-child{border-bottom:none}
.s-msg.live .role-hdr::after{content:'NEW';font-size:9px;background:rgba(63,185,80,.15);color:var(--green);padding:1px 5px;border-radius:3px;margin-left:8px}

.role-hdr{display:flex;align-items:center;gap:5px;font-size:10px;text-transform:uppercase;letter-spacing:1px;font-weight:600;margin-bottom:6px}
.rh-user{color:var(--accent)}
.rh-asst{color:var(--orange)}
.rh-tool{color:var(--green)}
.rh-meta{color:var(--t3)}

/* thinking (always expanded) */
.blk-think{
  background:var(--bg-2);border-left:3px solid var(--purple);
  border-radius:0 6px 6px 0;margin:4px 0;
}
.think-hdr{
  padding:6px 10px;
  display:flex;align-items:center;gap:6px;color:var(--purple);font-size:11px;
}
.think-body{overflow-y:auto}
.think-body pre{padding:0 10px 8px;color:var(--t2);font-size:11px;white-space:pre-wrap;word-break:break-word}

/* tool call */
.blk-tcall{
  background:var(--bg-2);border-left:3px solid var(--orange);
  border-radius:0 6px 6px 0;padding:8px 10px;margin:4px 0;
}
.tcall-name{color:var(--orange);font-weight:700;font-size:12px;display:flex;align-items:center;gap:6px}
.tcall-name .tid{color:var(--t3);font-size:10px;font-weight:400}
.tcall-args{margin-top:4px;color:var(--t2);font-size:11px;white-space:pre-wrap;word-break:break-word;max-height:180px;overflow-y:auto}
/* json syntax in args */
.jk{color:var(--accent)}
.js{color:var(--green2)}
.jn{color:var(--purple)}
.jw{color:var(--orange)}

/* tool result */
.blk-tres{
  background:var(--bg-2);border-left:3px solid var(--green);
  border-radius:0 6px 6px 0;padding:8px 10px;margin:4px 0;
  max-height:240px;overflow-y:auto;
}
.blk-tres pre{color:var(--t2);font-size:11px;white-space:pre-wrap;word-break:break-word}

/* assistant response block */
.blk-text{
  background:var(--bg-2);border-left:3px solid var(--accent);
  border-radius:0 6px 6px 0;margin:4px 0;
}
.text-hdr{
  padding:6px 10px;
  display:flex;align-items:center;gap:6px;color:var(--accent);font-size:11px;font-weight:600;
}
.text-body{padding:0 12px 10px;color:var(--t1);font-size:13px;word-break:break-word;line-height:1.6}
.text-body h1,.text-body h2,.text-body h3,.text-body h4,.text-body h5,.text-body h6{color:var(--t0);margin:12px 0 6px;font-weight:600}
.text-body h1{font-size:20px;border-bottom:1px solid var(--border);padding-bottom:4px}
.text-body h2{font-size:17px;border-bottom:1px solid var(--border);padding-bottom:3px}
.text-body h3{font-size:15px}
.text-body p{margin:6px 0}
.text-body ul,.text-body ol{margin:6px 0;padding-left:20px}
.text-body li{margin:2px 0}
.text-body code{background:var(--bg-3);color:var(--orange);padding:1px 5px;border-radius:3px;font-size:12px}
.text-body pre{background:var(--bg-3);border-radius:6px;padding:10px 12px;margin:8px 0;overflow-x:auto}
.text-body pre code{background:none;color:var(--t1);padding:0;font-size:12px}
.text-body blockquote{border-left:3px solid var(--purple);padding:4px 12px;margin:6px 0;color:var(--t2)}
.text-body table{border-collapse:collapse;margin:8px 0;width:100%}
.text-body th,.text-body td{border:1px solid var(--border);padding:6px 10px;font-size:12px;text-align:left}
.text-body th{background:var(--bg-3);font-weight:600;color:var(--t0)}
.text-body a{color:var(--accent);text-decoration:none}
.text-body a:hover{text-decoration:underline}
.text-body hr{border:none;border-top:1px solid var(--border);margin:12px 0}
.text-body img{max-width:100%;border-radius:4px}
/* user question block */
.blk-user{
  background:var(--bg-2);border-left:3px solid var(--green);
  border-radius:0 6px 6px 0;margin:4px 0;
}
.user-hdr{
  padding:6px 10px;
  display:flex;align-items:center;gap:6px;color:var(--green);font-size:11px;font-weight:600;
}
.user-body{padding:0 12px 10px;color:var(--t1);font-size:13px;white-space:pre-wrap;word-break:break-word;line-height:1.6}

/* meta / raw */
.blk-meta{
  background:var(--bg-2);border-left:3px solid var(--t3);
  border-radius:0 6px 6px 0;padding:6px 10px;margin:4px 0;
  font-size:10px;color:var(--t3);white-space:pre-wrap;word-break:break-word;
}

/* hamburger button (hidden on desktop) */
.menu-btn{
  display:none;
  width:36px;height:36px;border-radius:6px;
  border:1px solid var(--border);background:transparent;
  color:var(--t1);font-size:18px;
  cursor:pointer;align-items:center;justify-content:center;
  flex-shrink:0;
}
.menu-btn:hover{background:var(--bg-3);border-color:var(--border-hi)}

/* sidebar backdrop (hidden by default) */
.sidebar-backdrop{
  display:none;
  position:fixed;inset:0;z-index:99;
  background:rgba(0,0,0,.5);
}
.sidebar-backdrop.show{display:block}

/* ═══════════════════════════════════════════════════════════
   MOBILE RESPONSIVE (≤768px)
   ═══════════════════════════════════════════════════════════ */
@media(max-width:768px){
  /* ── Sidebar → slide-in drawer ── */
  .sidebar{
    position:fixed;left:0;top:0;bottom:0;z-index:100;
    transform:translateX(-100%);
    transition:transform .25s ease;
    width:280px;min-width:280px;
    box-shadow:4px 0 20px rgba(0,0,0,.4);
  }
  .sidebar.open{transform:translateX(0)}

  /* ── Show hamburger button ── */
  .menu-btn{display:flex}

  /* ── Main header → two-row layout ── */
  .main-hdr{
    flex-wrap:wrap;
    padding:8px 12px;gap:8px;
  }
  .mh-left{
    flex-direction:row;align-items:center;gap:8px;
    min-width:0;flex:1;
  }
  .mh-title{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .mh-right{
    width:100%;order:1;
    gap:8px;flex-wrap:wrap;
  }

  /* search stretches full width */
  .search-box{flex:1;min-width:0}
  .search-input{width:100%;flex:1}

  /* filter pills scroll horizontally */
  .filters{
    overflow-x:auto;flex-wrap:nowrap;
    -webkit-overflow-scrolling:touch;
    scrollbar-width:none;
    flex:1;min-width:0;
  }
  .filters::-webkit-scrollbar{display:none}
  .fpill{flex-shrink:0}

  /* hide "Scroll" label, keep toggle */
  .toggle-wrap span{display:none}

  /* ── Log rows → stacked layout ── */
  .log-header{display:none}
  .log-row{
    display:flex;flex-wrap:wrap;
    grid-template-columns:none;
    padding:8px 12px;gap:4px;
    position:relative;
  }
  .lr-time{font-size:10px;margin-right:6px}
  .lr-badge{font-size:9px}
  .lr-msg{
    width:100%;order:1;
    white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    padding-right:30px;
  }
  .log-row.expanded .lr-msg{white-space:pre-wrap;overflow:visible;text-overflow:clip}
  .lr-actions{
    position:absolute;top:6px;right:8px;
  }
  .copy-btn{opacity:1}

  /* ── Session summary → compact 2-col grid ── */
  .ss-row-top{
    display:grid;grid-template-columns:1fr 1fr;
    gap:8px;padding:10px 12px 8px;
  }
  .ss-del{
    grid-column:1/-1;
    margin-left:0;justify-content:center;
  }
  .ss-models{
    overflow-x:auto;flex-wrap:nowrap;
    -webkit-overflow-scrolling:touch;
    padding:0 12px 10px;
    scrollbar-width:none;
  }
  .ss-models::-webkit-scrollbar{display:none}
  .ss-model-tag{flex-shrink:0}

  /* ── Session summary collapsible on mobile ── */
  .ss-toggle{
    display:flex;align-items:center;justify-content:space-between;
    padding:10px 12px;cursor:pointer;
    border-bottom:1px solid var(--border);
    min-height:40px;
  }
  .ss-toggle-info{font-size:11px;color:var(--t1);font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1}
  .ss-toggle-arrow{font-size:10px;color:var(--t3);transition:transform .2s;flex-shrink:0;margin-left:8px}
  .ss-body{display:none}
  .sess-summary.ss-expanded .ss-body{display:contents}
  .sess-summary.ss-expanded .ss-toggle-arrow{transform:rotate(180deg)}

  /* ── Session detail blocks → full-width ── */
  .s-msg{padding:8px 10px}
  .blk-tcall{padding:6px 8px}
  .tcall-args{max-height:140px}
  .blk-tres{max-height:180px}
  .text-body pre{overflow-x:auto}

  /* ── Boot screen → narrower ── */
  .boot-box{max-width:90vw;width:90vw}
  .boot-steps{max-width:100%}
  .boot-progress{max-width:100%}
  .boot-alert{max-width:100%}
  .boot-info{max-width:100%}

  /* ── Touch targets (44px minimum) ── */
  .fpill{min-height:36px;display:inline-flex;align-items:center}
  .nav-btn{min-height:44px}
  .s-card{min-height:44px;padding:10px 11px}

  /* ── Toast position for mobile ── */
  .toast-container{top:auto;bottom:16px;right:12px;left:12px}
  .toast{font-size:13px}

  /* ── Scroll-to-top button ── */
  .scroll-top-btn{bottom:16px;right:16px}

  /* ── System dashboard responsive ── */
  .sys-grid{grid-template-columns:1fr!important}
}

/* ═══════════════════════════════════════════════════════════
   SYSTEM DASHBOARD
   ═══════════════════════════════════════════════════════════ */
.sys-toolbar{
  display:flex;align-items:center;justify-content:space-between;
  padding:12px 18px;border-bottom:1px solid var(--border);
  background:var(--bg-2);flex-shrink:0;
}
.sys-toolbar-left{font-size:11px;color:var(--t3)}
.sys-refresh-btn{
  padding:4px 12px;border-radius:5px;
  border:1px solid var(--border);background:transparent;
  color:var(--t2);font-size:11px;font-family:inherit;
  cursor:pointer;transition:all .15s;
  display:flex;align-items:center;gap:5px;
}
.sys-refresh-btn:hover{border-color:var(--accent);color:var(--accent);background:rgba(88,166,255,.06)}
.sys-grid{
  display:grid;grid-template-columns:1fr 1fr;gap:14px;
  padding:16px 18px;
}
.sys-card{
  background:var(--bg-1);border:1px solid var(--border);
  border-radius:8px;overflow:hidden;
}
.sys-card-hdr{
  display:flex;align-items:center;gap:8px;
  padding:10px 14px;border-bottom:1px solid var(--border);
  background:var(--bg-2);
  font-size:12px;font-weight:600;color:var(--t0);
}
.sys-card-hdr .sys-icon{font-size:14px;flex-shrink:0}
.sys-card-body{padding:10px 14px;font-size:11px;color:var(--t1);max-height:420px;overflow-y:auto}
.sys-card-body:empty::after{content:'—';color:var(--t3)}
.sys-kv{display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px solid var(--border)}
.sys-kv:last-child{border-bottom:none}
.sys-kv-key{color:var(--t2);flex-shrink:0;margin-right:10px}
.sys-kv-val{color:var(--t0);text-align:right;word-break:break-all}
.sys-badge-ok{display:inline-block;padding:1px 6px;border-radius:3px;font-size:9px;font-weight:700;background:rgba(63,185,80,.15);color:var(--green);text-transform:uppercase}
.sys-badge-warn{display:inline-block;padding:1px 6px;border-radius:3px;font-size:9px;font-weight:700;background:rgba(227,179,65,.12);color:var(--yellow);text-transform:uppercase}
.sys-badge-err{display:inline-block;padding:1px 6px;border-radius:3px;font-size:9px;font-weight:700;background:rgba(255,123,114,.15);color:var(--red);text-transform:uppercase}
.sys-tag{display:inline-block;padding:2px 8px;border-radius:10px;font-size:10px;background:var(--bg-3);border:1px solid var(--border);color:var(--t1);margin:2px}
.sys-bar{height:6px;background:var(--bg-3);border-radius:3px;overflow:hidden;margin:4px 0}
.sys-bar-fill{height:100%;border-radius:3px;transition:width .3s}
.sys-bar-fill.ok{background:var(--green)}
.sys-bar-fill.warn{background:var(--orange)}
.sys-bar-fill.err{background:var(--red)}
.sys-pre{background:var(--bg-2);border-radius:4px;padding:8px 10px;font-size:10px;color:var(--t2);white-space:pre-wrap;word-break:break-word;max-height:200px;overflow-y:auto;margin:4px 0}
.sys-empty{color:var(--t3);font-size:11px;padding:8px 0;text-align:center}
.sys-section-label{font-size:9px;font-weight:700;color:var(--accent);text-transform:uppercase;letter-spacing:.8px;padding:8px 0 3px;border-bottom:1px solid var(--border);margin-bottom:2px}
.sys-section-label:first-child{padding-top:0}

/* ═══════════════════════════════════════════════════════════
   SVG ICONS
   ═══════════════════════════════════════════════════════════ */
.icon{display:inline-flex;align-items:center;justify-content:center;width:1em;height:1em;vertical-align:middle;flex-shrink:0}
.icon svg{width:100%;height:100%;fill:none;stroke:currentColor;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}
.icon-sm{font-size:14px}
.icon-md{font-size:16px}
.icon-lg{font-size:18px}

/* ═══════════════════════════════════════════════════════════
   CUSTOM MODAL (delete confirmation)
   ═══════════════════════════════════════════════════════════ */
.modal-backdrop{
  position:fixed;inset:0;z-index:10000;
  background:rgba(0,0,0,.6);
  backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px);
  display:flex;align-items:center;justify-content:center;
  opacity:0;visibility:hidden;
  transition:opacity .2s ease,visibility .2s ease;
}
.modal-backdrop.show{opacity:1;visibility:visible}
.modal{
  width:380px;max-width:90vw;
  background:var(--bg-1);
  border:1px solid var(--border-hi);
  border-radius:12px;
  box-shadow:0 20px 60px rgba(0,0,0,.5),0 0 0 1px rgba(255,255,255,.03);
  transform:scale(.92) translateY(8px);
  transition:transform .25s cubic-bezier(.2,.9,.3,1.1);
  overflow:hidden;
}
.modal-backdrop.show .modal{transform:scale(1) translateY(0)}
.modal-header{
  padding:20px 24px 0;
  display:flex;align-items:center;gap:12px;
}
.modal-icon{
  width:40px;height:40px;border-radius:10px;
  background:rgba(255,123,114,.1);
  display:flex;align-items:center;justify-content:center;
  color:var(--red);font-size:20px;flex-shrink:0;
}
.modal-title{font-size:15px;font-weight:700;color:var(--t0)}
.modal-body{
  padding:12px 24px 0;
  font-size:12.5px;color:var(--t2);line-height:1.6;
}
.modal-body code{
  background:var(--bg-3);color:var(--orange);
  padding:2px 6px;border-radius:4px;font-size:11.5px;
  font-family:inherit;
}
.modal-footer{
  padding:16px 24px 20px;
  display:flex;justify-content:flex-end;gap:8px;
}
.modal-btn{
  padding:7px 18px;border-radius:7px;
  font-family:inherit;font-size:12px;font-weight:600;
  cursor:pointer;transition:all .15s;
  border:1px solid transparent;
}
.modal-btn-cancel{
  background:var(--bg-3);color:var(--t1);
  border-color:var(--border);
}
.modal-btn-cancel:hover{background:var(--bg-2);border-color:var(--border-hi)}
.modal-btn-danger{
  background:rgba(255,123,114,.15);color:var(--red);
  border-color:rgba(255,123,114,.3);
}
.modal-btn-danger:hover{background:rgba(255,123,114,.25);border-color:var(--red);box-shadow:0 0 12px rgba(255,123,114,.15)}

/* ═══════════════════════════════════════════════════════════
   BUTTON REFINEMENTS
   ═══════════════════════════════════════════════════════════ */
.theme-btn,.lang-btn,.logout-btn{transition:all .2s cubic-bezier(.2,.9,.3,1)}
.theme-btn:hover{transform:scale(1.08)}
.lang-btn:hover{transform:scale(1.08)}
.logout-btn:hover{transform:scale(1.08)}
.copy-btn{transition:all .2s cubic-bezier(.2,.9,.3,1)}
.copy-btn:hover{transform:scale(1.1)}
.nav-btn{transition:background .2s,border-color .2s,color .2s,transform .15s}
.nav-btn:active{transform:scale(.98)}
.s-card{transition:background .2s,border-color .2s,transform .15s}
.s-card:active{transform:scale(.99)}
.toast{box-shadow:0 8px 24px rgba(0,0,0,.35),0 0 0 1px rgba(255,255,255,.04)}
</style>
</head>
<body>

<!-- ═══ BOOT SCREEN ═══════════════════════════════════════ -->
<div class="boot-screen" id="boot-screen">
  <div class="boot-box">
    <div class="boot-logo"><em>openclaw</em> monitor</div>

    <div class="boot-spinner-wrap">
      <div class="boot-spinner" id="boot-spinner"></div>
      <div class="boot-icon" id="boot-icon"></div>
    </div>

    <div class="boot-steps" id="boot-steps">
      <div class="boot-step" id="boot-step-proc">
        <span class="boot-step-icon">1</span>
        <div>
          <div class="boot-step-text" id="boot-step-proc-text">Detecting openclaw process…</div>
        </div>
      </div>
      <div class="boot-step" id="boot-step-log">
        <span class="boot-step-icon">2</span>
        <div>
          <div class="boot-step-text" id="boot-step-log-text">Locating log files…</div>
        </div>
      </div>
      <div class="boot-step" id="boot-step-sess">
        <span class="boot-step-icon">3</span>
        <div>
          <div class="boot-step-text" id="boot-step-sess-text">Loading sessions…</div>
        </div>
      </div>
    </div>

    <div class="boot-progress"><div class="boot-progress-bar" id="boot-progress"></div></div>

    <!-- shown when openclaw is not detected -->
    <div class="boot-alert" id="boot-alert">
      <div class="boot-alert-icon"><span class="icon" style="font-size:40px;color:var(--red)"><svg viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></span></div>
      <div class="boot-alert-title" id="boot-alert-title">openclaw not detected</div>
      <div class="boot-alert-desc" id="boot-alert-desc">
        The openclaw process is not running or not accessible on this server.
      </div>
      <div class="boot-alert-hint" id="boot-alert-hint">
        Make sure openclaw is installed and running:<br>
        <code>openclaw</code>
      </div>
      <button class="boot-retry-btn" id="boot-retry" onclick="bootCheck()">Retry</button>
    </div>

    <!-- env info shown on success -->
    <div class="boot-info" id="boot-info">
      <div class="boot-info-row">
        <span class="boot-info-label" id="boot-info-sess-label">Session Dir</span>
        <span class="boot-info-val" id="boot-info-sess-val">—</span>
      </div>
      <div class="boot-info-row">
        <span class="boot-info-label" id="boot-info-log-label">Today Log</span>
        <span class="boot-info-val" id="boot-info-log-val">—</span>
      </div>
    </div>
  </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toast-container"></div>

<!-- Delete Confirmation Modal -->
<div class="modal-backdrop" id="modal-backdrop">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-icon"><span class="icon" style="font-size:20px"><svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg></span></div>
      <div class="modal-title" id="modal-title">Delete Session</div>
    </div>
    <div class="modal-body" id="modal-body"></div>
    <div class="modal-footer">
      <button class="modal-btn modal-btn-cancel" id="modal-cancel"></button>
      <button class="modal-btn modal-btn-danger" id="modal-confirm"></button>
    </div>
  </div>
</div>

<!-- ═══ SIDEBAR ═══════════════════════════════════════════ -->
<aside class="sidebar">
  <div class="sb-head">
    <div class="sb-logo"><em>openclaw</em> monitor</div>
    <div class="live-tag"><span class="live-dot"></span>live</div>
  </div>

  <div class="sb-nav">
    <button class="nav-btn active" id="btn-live">
      <span class="nb-icon icon icon-sm"><svg viewBox="0 0 24 24"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg></span>
      <span class="nb-label">Live Logs</span>
      <span class="nb-badge" id="evt-cnt">0</span>
    </button>
    <button class="nav-btn" id="btn-system">
      <span class="nb-icon icon icon-sm"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg></span>
      <span class="nb-label">System</span>
    </button>
  </div>

  <div class="sb-label">Sessions <span id="sess-active" style="color:var(--green);margin-left:6px"></span></div>
  <div class="sb-sessions" id="sb-sessions">
    <div class="empty"><p>No sessions</p></div>
  </div>

  <div class="sb-foot">
    <div class="sb-foot-row">
      <div class="sb-foot-left">
        <span class="cd connecting" id="conn-dot"></span>
        <span class="cd-label" id="conn-label">Connecting…</span>
      </div>
      <div class="sb-foot-right">
        <button class="lang-btn" id="lang-btn" title="切换语言/Language">中</button>
        <button class="theme-btn" id="theme-btn" title="Toggle theme"><span class="icon icon-sm" id="theme-icon"><svg viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1111.21 3a7 7 0 009.79 9.79z"/></svg></span></button>
        <button class="logout-btn" id="logout-btn" title="Logout"><span class="icon icon-sm"><svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg></span></button>
      </div>
    </div>
    <div class="sb-version" id="sb-version"></div>
  </div>
</aside>
<div class="sidebar-backdrop" id="sidebar-backdrop"></div>

<!-- ═══ MAIN ═══════════════════════════════════════════════ -->
<main class="main">
  <div class="main-hdr">
    <button class="menu-btn" id="menu-btn" title="Menu"><span class="icon icon-lg"><svg viewBox="0 0 24 24"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg></span></button>
    <div class="mh-left">
      <span class="mh-title" id="mh-title">Live Logs</span>
      <span class="mh-sub"  id="mh-sub">openclaw logs --follow</span>
    </div>
    <div class="mh-right">
      <div class="search-box" id="search-box">
        <input type="text" class="search-input" id="search-input" placeholder="Search logs...">
        <button class="search-clear" id="search-clear"><span class="icon" style="font-size:12px"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></span></button>
      </div>
      <div class="filters" id="filters">
        <button class="fpill active" data-f="all">All</button>
        <button class="fpill" data-f="queue">Queue</button>
        <button class="fpill" data-f="run">Run</button>
        <button class="fpill" data-f="tool">Tool</button>
        <button class="fpill" data-f="session">Session</button>
        <button class="fpill" data-f="error">Error</button>
      </div>
      <div class="toggle-wrap">
        <span>Scroll</span>
        <div class="tog on" id="tog-scroll"><div class="knob"></div></div>
      </div>
      <button class="btn-clr" id="btn-clr">Clear</button>
    </div>
  </div>

  <!-- session summary bar (hidden until a session is selected) -->
  <div class="sess-summary" id="sess-summary" style="display:none">
    <div class="ss-toggle" id="ss-toggle">
      <span class="ss-toggle-info" id="ss-toggle-info">—</span>
      <span class="ss-toggle-arrow" id="ss-toggle-arrow">▼</span>
    </div>
    <div class="ss-body" id="ss-body">
    <div class="ss-row-top">
      <div class="ss-item"><span class="ss-label">Session</span><span class="ss-val" id="ss-id">—</span></div>
      <div class="ss-item"><span class="ss-label">Provider</span><span class="ss-val" id="ss-provider">—</span></div>
      <div class="ss-item"><span class="ss-label">Model</span><span class="ss-val" id="ss-model">—</span></div>
      <div class="ss-item"><span class="ss-label">Messages</span><span class="ss-val" id="ss-msgs">—</span></div>
      <div class="ss-item"><span class="ss-label">Status</span><span class="ss-val" id="ss-status">—</span></div>
      <div class="ss-item"><span class="ss-label">Tokens</span><span class="ss-val" id="ss-tokens">—</span></div>
      <div class="ss-item"><span class="ss-label">Cost</span><span class="ss-val" id="ss-cost">—</span></div>
    </div>
    <div class="ss-models" id="ss-models"></div>
    </div><!-- /.ss-body -->
  </div>

  <div class="stream" id="stream">
    <div class="empty"><div class="ei"></div><p id="stream-wait-text">Waiting for events…</p></div>
  </div>
  <button class="scroll-top-btn" id="scroll-top-btn" title="Scroll to top"><span class="icon icon-md"><svg viewBox="0 0 24 24"><polyline points="18 15 12 9 6 15"/></svg></span></button>
</main>

<!-- ═══ SCRIPT ═════════════════════════════════════════════ -->
<script>
/* ── state ──────────────────────────────────────────────── */
const S = {
  view:        'live',   // 'live' | 'system' | sessionId
  filter:      'all',
  autoScroll:  true,
  sessions:    [],
  liveLogs:    [],       // buffer for re-filter
  es:          null,     // current EventSource
  historyDone: false,
  searchQuery: '',       // search query
  theme:       'dark',   // 'dark' | 'light'
  lang:        'zh',     // 'en' | 'zh'
  systemData:  null,
  systemTimer: null,
};

/* ── i18n (国际化) ────────────────────────────────────────── */
const I18N = {
  en: {
    liveLogs: 'Live Logs',
    sessions: 'Sessions',
    active: 'active',
    noSessions: 'No sessions found',
    deleteSession: 'Delete session',
    msgs: 'msgs',
    connected: 'Connected',
    disconnected: 'Disconnected',
    connecting: 'Connecting…',
    time: 'Time',
    type: 'Type',
    content: 'Content',
    actions: 'Actions',
    all: 'All',
    queue: 'Queue',
    run: 'Run',
    tool: 'Tool',
    session: 'Session',
    error: 'Error',
    scroll: 'Scroll',
    clear: 'Clear',
    searchLogs: 'Search logs...',
    waiting: 'Waiting for events…',
    copySuccess: 'Copied!',
    copyFailed: 'Copy failed',
    provider: 'Provider',
    model: 'Model',
    messages: 'Messages',
    status: 'Status',
    user: 'User',
    assistant: 'Assistant',
    toolResult: 'Tool Result',
    meta: 'Meta',
    thinking: 'Thinking',
    response: 'Response',
    deleteConfirm: 'Delete session',
    deleteConfirmTitle: 'Delete Session',
    deleteConfirmMsg: 'Are you sure you want to delete session <code>{0}</code>? This action cannot be undone.',
    modalCancel: 'Cancel',
    modalDelete: 'Delete',
    tokens: 'Tokens',
    cost: 'Cost',
    inputTokens: 'In',
    outputTokens: 'Out',
    cacheTokens: 'Cache',
    idle: 'idle',
    processing: 'processing',
    idleFor: 'idle {0}',
    justNow: 'just now',
    minutesAgo: '{0}m ago',
    hoursAgo: '{0}h ago',
    daysAgo: '{0}d ago',
    // System view
    system: 'System',
    sysRefresh: 'Refresh',
    sysLastUpdate: 'Last updated',
    sysChannelHealth: 'Channel Health',
    sysDiagnostics: 'System Diagnostics',
    sysPresence: 'Heartbeat & Presence',
    sysContextWindow: 'Context Window',
    sysPromptReport: 'System Prompt Report',
    sysSkillsSnapshot: 'Skills Snapshot',
    sysCompaction: 'Compaction History',
    sysDevices: 'Devices',
    sysCronJobs: 'Cron Jobs',
    sysUpdateCheck: 'Update Check',
    sysExecApprovals: 'Exec Approvals',
    sysPaired: 'Paired',
    sysPending: 'Pending',
    sysNoData: 'No data available',
    sysNoJobs: 'No cron jobs configured',
    sysVersion: 'Version',
    sysLastChecked: 'Last Checked',
    sysSocket: 'Socket',
    sysCompactions: 'compactions',
    sysLoading: 'Loading system data…',
  },
  zh: {
    liveLogs: '实时日志',
    sessions: '会话列表',
    active: '运行中',
    noSessions: '暂无会话',
    deleteSession: '删除会话',
    msgs: '条消息',
    connected: '已连接',
    disconnected: '已断开',
    connecting: '连接中…',
    time: '时间',
    type: '类型',
    content: '内容',
    actions: '操作',
    all: '全部',
    queue: '队列',
    run: '运行',
    tool: '工具',
    session: '会话',
    error: '错误',
    scroll: '自动滚动',
    clear: '清空',
    searchLogs: '搜索日志...',
    waiting: '等待事件中…',
    copySuccess: '已复制!',
    copyFailed: '复制失败',
    provider: '提供商',
    model: '模型',
    messages: '消息数',
    status: '状态',
    user: '用户',
    assistant: '助手',
    toolResult: '工具结果',
    meta: '元数据',
    thinking: '思考中',
    response: '回答',
    deleteConfirm: '删除会话',
    deleteConfirmTitle: '删除会话',
    deleteConfirmMsg: '确定要删除会话 <code>{0}</code> 吗？此操作无法撤销。',
    modalCancel: '取消',
    modalDelete: '删除',
    tokens: 'Tokens',
    cost: '费用',
    inputTokens: '输入',
    outputTokens: '输出',
    cacheTokens: '缓存',
    idle: '空闲',
    processing: '运行中',
    idleFor: '空闲 {0}',
    justNow: '刚刚',
    minutesAgo: '{0}分钟前',
    hoursAgo: '{0}小时前',
    daysAgo: '{0}天前',
    // System view
    system: '系统',
    sysRefresh: '刷新',
    sysLastUpdate: '上次更新',
    sysChannelHealth: '通道状态',
    sysDiagnostics: '系统诊断',
    sysPresence: '心跳 & 在线状态',
    sysContextWindow: '上下文窗口',
    sysPromptReport: '系统提示报告',
    sysSkillsSnapshot: '技能快照',
    sysCompaction: '压缩历史',
    sysDevices: '设备',
    sysCronJobs: '定时任务',
    sysUpdateCheck: '更新检查',
    sysExecApprovals: '执行审批',
    sysPaired: '已配对',
    sysPending: '待确认',
    sysNoData: '暂无数据',
    sysNoJobs: '未配置定时任务',
    sysVersion: '版本',
    sysLastChecked: '上次检查',
    sysSocket: 'Socket',
    sysCompactions: '次压缩',
    sysLoading: '正在加载系统数据…',
  }
};

function i18n(key) {
  return I18N[S.lang]?.[key] || I18N.en[key] || key;
}

/* Translate raw API field names for display */
const KEY_ZH = {
  source:'来源', run:'运行', generatedAt:'生成时间', sessionId:'会话ID', sessionKey:'会话密钥',
  provider:'提供商', model:'模型', workspaceDir:'工作目录', bootstrapMaxChars:'引导最大字符数',
  sandbox:'沙盒', host:'主机', hostname:'主机名', ip:'IP', mode:'模式', status:'状态',
  timestamp:'时间戳', uptime:'运行时长', platform:'平台', role:'角色', clientMode:'客户端模式',
  version:'版本', socket:'套接字', path:'路径', agents:'代理', defaults:'默认值',
  lastNotifiedVersion:'最新通知版本', lastNotifiedTag:'最新通知标签', lastCheckedAt:'上次检查时间',
  name:'名称', channel:'通道', error:'错误', type:'类型', schedule:'计划',
  command:'命令', enabled:'启用', lastRun:'上次运行', nextRun:'下次运行',
  compactionCount:'压缩次数', contextTokens:'上下文Tokens', totalTokens:'总Tokens', percent:'百分比',
  messages:'消息数', tokens:'Tokens', cost:'费用', cwd:'工作目录', pid:'进程ID',
  startedAt:'开始时间', lastActiveAt:'上次活跃', project:'项目', user:'用户',
  description:'描述', id:'ID', key:'键', value:'值', count:'数量', size:'大小',
  maxTokens:'最大Tokens', temperature:'温度', topP:'Top P', topK:'Top K',
  prompt:'提示词', system:'系统', input:'输入', output:'输出', cache:'缓存',
  inputTokens:'输入Tokens', outputTokens:'输出Tokens', cacheTokens:'缓存Tokens',
  tools:'工具', skill:'技能', skills:'技能列表', config:'配置', settings:'设置',
  timeout:'超时', interval:'间隔', retries:'重试次数', maxRetries:'最大重试次数',
  url:'URL', port:'端口', address:'地址', protocol:'协议',
  created:'创建时间', updated:'更新时间', deleted:'删除时间',
  active:'活跃', inactive:'非活跃', pending:'待处理', completed:'已完成',
  failed:'失败', success:'成功', running:'运行中', stopped:'已停止',
  duration:'时长', elapsed:'已用时间', remaining:'剩余时间',
  filename:'文件名', directory:'目录', extension:'扩展名',
  paired:'已配对', pairedAt:'配对时间', lastUsedAtMs:'上次使用时间',
  // Channel Health (openclaw status --json)
  heartbeat:'心跳', defaultAgentId:'默认代理ID', agentId:'代理ID',
  every:'执行间隔', everyMs:'间隔(毫秒)',
  channelSummary:'通道摘要', queuedSystemEvents:'排队事件',
  sessions:'会话', paths:'路径列表', recent:'最近会话', byAgent:'按代理分组',
  kind:'类型', updatedAt:'更新时间', age:'存活时间',
  systemSent:'系统已发送', abortedLastRun:'上次中断',
  remainingTokens:'剩余Tokens', percentUsed:'使用率', flags:'标签',
  // OS
  os:'操作系统', arch:'架构', release:'内核版本', label:'标签',
  // Update
  update:'更新信息', root:'根路径', installKind:'安装方式', packageManager:'包管理器',
  deps:'依赖', registry:'注册表', manager:'管理器',
  lockfilePath:'锁文件路径', markerPath:'标记文件路径', reason:'原因',
  latestVersion:'最新版本', updateChannel:'更新通道', updateChannelSource:'更新通道来源',
  // Memory
  memory:'记忆', memoryPlugin:'记忆插件', slot:'插槽',
  // Gateway
  gateway:'网关', urlSource:'URL来源', misconfigured:'配置异常',
  reachable:'可达', connectLatencyMs:'连接延迟(ms)', self:'本机',
  // Services
  gatewayService:'网关服务', nodeService:'节点服务',
  installed:'已安装', loadedText:'加载状态', runtimeShort:'运行状态',
  // Agents
  defaultId:'默认ID', totalSessions:'总会话数',
  bootstrapPendingCount:'待引导数量', bootstrapPending:'待引导',
  sessionsPath:'会话路径', sessionsCount:'会话数量',
  lastUpdatedAt:'上次更新时间', lastActiveAgeMs:'上次活跃(ms)',
  // Security Audit
  securityAudit:'安全审计', ts:'时间戳', summary:'摘要', findings:'发现',
  critical:'严重', warn:'警告', info:'信息',
  checkId:'检查项', severity:'严重程度', title:'标题', detail:'详情', remediation:'修复建议',
  // Presence
  deviceFamily:'设备类型', modelIdentifier:'型号标识', deviceId:'设备ID',
  roles:'角色列表', scopes:'权限范围', instanceId:'实例ID', text:'描述',
  // Diagnostics
  issues:'问题列表', issueCount:'问题数量',
  // System Prompt Report
  systemPrompt:'系统提示词', chars:'字符数',
  projectContextChars:'项目上下文字符数', nonProjectContextChars:'非项目上下文字符数',
  injectedWorkspaceFiles:'注入工作区文件', missing:'缺失',
  rawChars:'原始字符数', injectedChars:'注入字符数', truncated:'已截断',
  promptChars:'提示词字符数', entries:'条目', blockChars:'块字符数',
  summaryChars:'摘要字符数', schemaChars:'模式字符数', propertiesCount:'属性数量',
  listChars:'列表字符数', sandboxed:'沙盒化',
  // Devices extra
  publicKey:'公钥', clientId:'客户端ID', token:'令牌',
  // Cron Jobs
  jobs:'任务列表',
};
function translateKey(k) {
  if (S.lang !== 'zh') return k;
  if (KEY_ZH[k]) return KEY_ZH[k];
  // camelCase → spaced words: bootstrapMaxChars → Bootstrap Max Chars
  return k.replace(/([a-z])([A-Z])/g, '$1 $2')
          .replace(/([A-Z]+)([A-Z][a-z])/g, '$1 $2')
          .replace(/^./, c => c.toUpperCase());
}

function showToast(msg, type = 'success') {
  const container = document.getElementById('toast-container');
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = msg;
  container.appendChild(toast);
  setTimeout(() => {
    toast.style.animation = 'toast-out .2s ease forwards';
    setTimeout(() => toast.remove(), 200);
  }, 2000);
}

/* ── mobile sidebar helpers ─────────────────────────────── */
function isMobile() { return window.innerWidth <= 768; }

function openSidebar() {
  document.querySelector('.sidebar').classList.add('open');
  document.getElementById('sidebar-backdrop').classList.add('show');
}

function closeSidebar() {
  document.querySelector('.sidebar').classList.remove('open');
  document.getElementById('sidebar-backdrop').classList.remove('show');
}

/* ── version ─────────────────────────────────────────────── */
function fetchVersion() {
  fetch('/api/version').then(r => r.json()).then(d => {
    const el = document.getElementById('sb-version');
    if (el && d.version) el.textContent = 'v' + d.version;
  }).catch(() => {});
}

/* ── init ───────────────────────────────────────────────── */
document.addEventListener('DOMContentLoaded', () => {
  initTheme();
  initLang();
  initAutoScroll();
  fetchVersion();
  bindAll();
  bootCheck();  // start detection flow instead of immediately loading
});

/* ═══════════════════════════════════════════════════════════
   BOOT DETECTION FLOW
   ═══════════════════════════════════════════════════════════ */
async function bootCheck() {
  const screen   = document.getElementById('boot-screen');
  const spinner  = document.getElementById('boot-spinner');
  const icon     = document.getElementById('boot-icon');
  const progress = document.getElementById('boot-progress');
  const alert    = document.getElementById('boot-alert');
  const info     = document.getElementById('boot-info');

  // skip boot animation on page refresh (only show on fresh tab open)
  const isRefresh = sessionStorage.getItem('booted');
  if (isRefresh) {
    screen.classList.add('hidden');
    // still need to check health and load data
    let health;
    try {
      const res = await fetch('/api/health');
      health = await res.json();
    } catch (e) {
      health = { openclaw_available: false, session_dir_exists: false, today_log_exists: false };
    }
    if (!health.openclaw_available && !health.session_dir_exists) {
      // show boot screen with error on failure
      sessionStorage.removeItem('booted');
      return bootCheck();
    }
    try {
      S.sessions = await (await fetch('/api/sessions')).json();
      renderSessions();
    } catch(e) {
      S.sessions = [];
    }
    switchView('live');
    setInterval(loadSessions, 5000);
    return;
  }

  // reset state
  screen.classList.remove('hidden');
  spinner.className = 'boot-spinner';
  icon.className = 'boot-icon';
  icon.textContent = '';
  alert.classList.remove('show');
  info.classList.remove('show');
  progress.style.width = '0%';
  progress.classList.remove('fail');
  ['boot-step-proc','boot-step-log','boot-step-sess'].forEach(id => {
    const el = document.getElementById(id);
    el.className = 'boot-step';
  });

  // update boot screen i18n text
  updateBootText();

  // ── Step 1: detect openclaw process ──
  setBootStep('boot-step-proc', 'active');
  progress.style.width = '15%';

  await sleep(400);

  let health;
  try {
    const res = await fetch('/api/health');
    health = await res.json();
  } catch (e) {
    health = { openclaw_available: false, session_dir_exists: false, today_log_exists: false };
  }

  progress.style.width = '33%';

  if (!health.openclaw_available && !health.session_dir_exists) {
    // not detected
    setBootStep('boot-step-proc', 'fail');
    spinner.className = 'boot-spinner fail';
    icon.className = 'boot-icon show';
    icon.textContent = '✕';
    progress.classList.add('fail');
    progress.style.width = '33%';
    alert.classList.add('show');
    updateBootAlertText(health);
    return;
  }

  setBootStep('boot-step-proc', 'done');
  await sleep(300);

  // ── Step 2: locate log files ──
  setBootStep('boot-step-log', 'active');
  progress.style.width = '50%';
  await sleep(400);

  const logExists = health.today_log_exists;
  const sessExists = health.session_dir_exists;

  setBootStep('boot-step-log', 'done');
  progress.style.width = '66%';
  await sleep(300);

  // ── Step 3: load sessions ──
  setBootStep('boot-step-sess', 'active');
  progress.style.width = '80%';

  try {
    S.sessions = await (await fetch('/api/sessions')).json();
    renderSessions();
  } catch(e) {
    S.sessions = [];
  }

  setBootStep('boot-step-sess', 'done');
  progress.style.width = '100%';

  // show env info
  info.classList.add('show');
  document.getElementById('boot-info-sess-val').textContent = sessExists ? '✓' : '—';
  document.getElementById('boot-info-log-val').textContent  = logExists  ? '✓' : '—';
  if (health.output) {
    document.getElementById('boot-info-sess-val').textContent = sessExists ? '✓ found' : '✕ missing';
    document.getElementById('boot-info-log-val').textContent  = logExists  ? '✓ found' : '✕ missing';
  }

  // success
  spinner.className = 'boot-spinner ok';
  icon.className = 'boot-icon show';
  icon.textContent = '✓';

  await sleep(800);

  // mark as booted for this tab session (survives refresh, cleared on tab close)
  sessionStorage.setItem('booted', '1');

  // fade out and enter dashboard
  screen.classList.add('hidden');
  switchView('live');
  setInterval(loadSessions, 5000);
}

function setBootStep(id, state) {
  const el = document.getElementById(id);
  el.className = 'boot-step ' + state;
  const iconEl = el.querySelector('.boot-step-icon');
  if (state === 'done')      iconEl.textContent = '✓';
  else if (state === 'fail') iconEl.textContent = '✕';
}

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

function updateBootText() {
  document.getElementById('boot-step-proc-text').textContent =
    S.lang === 'zh' ? '检测 openclaw 进程…' : 'Detecting openclaw process…';
  document.getElementById('boot-step-log-text').textContent =
    S.lang === 'zh' ? '探测日志文件位置…' : 'Locating log files…';
  document.getElementById('boot-step-sess-text').textContent =
    S.lang === 'zh' ? '加载会话数据…' : 'Loading sessions…';
}

function updateBootAlertText(health) {
  const titleEl = document.getElementById('boot-alert-title');
  const descEl  = document.getElementById('boot-alert-desc');
  const hintEl  = document.getElementById('boot-alert-hint');
  const retryEl = document.getElementById('boot-retry');

  if (S.lang === 'zh') {
    titleEl.textContent = '未检测到 openclaw';
    descEl.textContent  = 'openclaw 进程未运行或无法访问。';
    hintEl.innerHTML    = '请确保 openclaw 已安装并正在运行：<br><code>openclaw</code>';
    retryEl.textContent = '重试';
  } else {
    titleEl.textContent = 'openclaw not detected';
    descEl.textContent  = 'The openclaw process is not running or not accessible on this server.';
    hintEl.innerHTML    = 'Make sure openclaw is installed and running:<br><code>openclaw</code>';
    retryEl.textContent = 'Retry';
  }
}

/* ── theme management ───────────────────────────────────── */
function initTheme() {
  const saved = localStorage.getItem('theme') || 'dark';
  S.theme = saved;
  applyTheme(saved);
}

function toggleTheme() {
  S.theme = S.theme === 'dark' ? 'light' : 'dark';
  localStorage.setItem('theme', S.theme);
  applyTheme(S.theme);
}

function applyTheme(theme) {
  document.documentElement.setAttribute('data-theme', theme);
  const icon = document.getElementById('theme-icon');
  if (theme === 'dark') {
    icon.innerHTML = '<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>';
  } else {
    icon.innerHTML = '<svg viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1111.21 3a7 7 0 009.79 9.79z"/></svg>';
  }
  document.getElementById('theme-btn').title = theme === 'dark' ? 'Switch to light theme' : 'Switch to dark theme';
}

/* ── auto-scroll persistence ───────────────────────────── */
function initAutoScroll() {
  const saved = localStorage.getItem('autoScroll');
  if (saved !== null) {
    S.autoScroll = saved === 'true';
  }
  document.getElementById('tog-scroll').classList.toggle('on', S.autoScroll);
}

/* ── language management ───────────────────────────────── */
function initLang() {
  const saved = localStorage.getItem('lang') || 'zh';
  S.lang = saved;
  applyLang(saved);
}

function toggleLang() {
  S.lang = S.lang === 'en' ? 'zh' : 'en';
  localStorage.setItem('lang', S.lang);
  applyLang(S.lang);
}

function applyLang(lang) {
  const btn = document.getElementById('lang-btn');
  btn.textContent = lang === 'en' ? '中' : 'EN';
  btn.title = lang === 'en' ? '切换到中文' : 'Switch to English';
  updateAllText();
}

function updateAllText() {
  // Sidebar
  document.querySelector('.sb-label').innerHTML = `${i18n('sessions')} <span id="sess-active" style="color:var(--green);margin-left:6px"></span>`;
  document.querySelector('#btn-live .nb-label').textContent = i18n('liveLogs');
  document.querySelector('#btn-system .nb-label').textContent = i18n('system');

  // Main header (if on live view)
  if (S.view === 'live') {
    document.getElementById('mh-title').textContent = i18n('liveLogs');
  } else if (S.view === 'system') {
    document.getElementById('mh-title').textContent = i18n('system');
  }

  // Search
  document.getElementById('search-input').placeholder = i18n('searchLogs');

  // Filter pills
  const filters = document.querySelectorAll('.fpill');
  const filterKeys = ['all', 'queue', 'run', 'tool', 'session', 'error'];
  filters.forEach((btn, i) => {
    if (filterKeys[i]) btn.textContent = i18n(filterKeys[i]);
  });

  // Toggle and clear
  document.querySelector('.toggle-wrap span').textContent = i18n('scroll');
  document.getElementById('btn-clr').textContent = i18n('clear');

  // Session summary labels
  const ssLabels = document.querySelectorAll('.ss-label');
  const labelKeys = ['session', 'provider', 'model', 'messages', 'status', 'tokens', 'cost'];
  ssLabels.forEach((el, i) => {
    if (labelKeys[i]) el.textContent = i18n(labelKeys[i]);
  });

  // Connection status
  const dot = document.getElementById('conn-dot');
  if (dot.classList.contains('connected')) {
    document.getElementById('conn-label').textContent = i18n('connected');
  } else if (dot.classList.contains('disconnected')) {
    document.getElementById('conn-label').textContent = i18n('disconnected');
  } else {
    document.getElementById('conn-label').textContent = i18n('connecting');
  }

  // Update stream waiting text if present
  const waitText = document.getElementById('stream-wait-text');
  if (waitText) waitText.textContent = i18n('waiting');

  // Re-render system view if active (to update card titles)
  if (S.view === 'system' && S.systemData) {
    renderSystem(S.systemData);
  }

  // Re-render sessions to update text
  renderSessions();

  // Update log header if present
  const logHeader = document.querySelector('.log-header');
  if (logHeader) {
    logHeader.innerHTML = `<span>${i18n('time')}</span><span>${i18n('type')}</span><span>${i18n('content')}</span><span>${i18n('actions')}</span>`;
  }
}

/* ── load sessions via REST ─────────────────────────────── */
async function loadSessions() {
  try {
    S.sessions = await (await fetch('/api/sessions')).json();
    renderSessions();
  } catch(e) { console.error('sessions load:', e); }
}

/* ── custom modal helper ────────────────────────────────── */
function showModal(title, bodyHtml, onConfirm) {
  const backdrop = document.getElementById('modal-backdrop');
  document.getElementById('modal-title').textContent = title;
  document.getElementById('modal-body').innerHTML = bodyHtml;
  const cancelBtn = document.getElementById('modal-cancel');
  const confirmBtn = document.getElementById('modal-confirm');
  cancelBtn.textContent = i18n('modalCancel');
  confirmBtn.textContent = i18n('modalDelete');

  function close() {
    backdrop.classList.remove('show');
    cancelBtn.onclick = null;
    confirmBtn.onclick = null;
    backdrop.onclick = null;
  }

  cancelBtn.onclick = close;
  confirmBtn.onclick = () => { close(); onConfirm(); };
  backdrop.onclick = (e) => { if (e.target === backdrop) close(); };
  backdrop.classList.add('show');
}

/* ── delete session ─────────────────────────────────────── */
async function deleteSession(sid) {
  const shortId = sid.substring(0, 8) + '…';
  showModal(
    i18n('deleteConfirmTitle'),
    i18n('deleteConfirmMsg').replace('{0}', shortId),
    async () => {
      try {
        const res = await fetch(`/api/session/${sid}`, { method: 'DELETE' });
        if (res.ok) {
          if (S.view === sid) switchView('live');
          loadSessions();
          showToast(i18n('deleteConfirm') + ' ' + shortId, 'success');
        } else {
          const err = await res.text();
          showToast('Delete failed: ' + err, 'error');
        }
      } catch(e) {
        console.error('delete session:', e);
        showToast('Delete failed: ' + e.message, 'error');
      }
    }
  );
}

/* ── render session cards ───────────────────────────────── */
function renderSessions() {
  const el = document.getElementById('sb-sessions');
  if (!S.sessions.length) {
    el.innerHTML = `<div class="empty" style="min-height:100px"><p>${i18n('noSessions')}</p></div>`;
    document.getElementById('sess-active').textContent = '';
    return;
  }
  // Sort sessions: processing first, then by mtime
  S.sessions.sort((a, b) => {
    if (a.status === 'processing' && b.status !== 'processing') return -1;
    if (a.status !== 'processing' && b.status === 'processing') return 1;
    return (b.mtime || 0) - (a.mtime || 0);
  });
  const active = S.sessions.filter(s => s.status === 'processing').length;
  document.getElementById('sess-active').textContent = active ? `${active} ${i18n('active')}` : '';

  el.innerHTML = S.sessions.map(s => {
    const short = s.id.substring(0,8) + '-' + s.id.substring(9,13) + '…';
    const isAct = S.view === s.id;
    const proc  = s.status === 'processing';
    const statusText = proc ? i18n('processing') : fmtIdleTime(s.idle_since);
    return `<div class="s-card${isAct?' active':''}${proc?' processing':''}" data-session="${s.id}" onclick="switchView('${s.id}')">
      <div class="s-card-top">
        <span class="s-card-id">${short}</span>
        <span class="badge ${proc?'badge-proc':'badge-idle'}">
          ${proc?'<span class="bd"></span>':''}${statusText}
        </span>
      </div>
      <div class="s-card-bot">
        <span>${s.provider||'—'} / ${s.model||'—'}</span>
        <span>${s.message_count||0} ${i18n('msgs')}</span>
      </div>
    </div>`;
  }).join('');
}

/* ── view switch ────────────────────────────────────────── */
function switchView(id) {
  if (isMobile()) closeSidebar();
  closeES();
  if (S.systemTimer) { clearInterval(S.systemTimer); S.systemTimer = null; }
  S.view = id;
  S.historyDone = false;
  clearStream();

  // update sidebar active
  document.querySelectorAll('.nav-btn,.s-card').forEach(e => e.classList.remove('active'));

  if (id === 'live') {
    document.getElementById('btn-live').classList.add('active');
    document.getElementById('mh-title').textContent = i18n('liveLogs');
    document.getElementById('mh-sub').textContent   = 'openclaw logs --follow';
    document.getElementById('filters').style.display = 'flex';
    document.getElementById('search-box').style.display = 'flex';
    document.getElementById('sess-summary').style.display = 'none';
    const delBtn = document.getElementById('ss-del');
    if (delBtn) delBtn.remove();
    S.liveLogs = [];
    startLive();
  } else if (id === 'system') {
    document.getElementById('btn-system').classList.add('active');
    document.getElementById('mh-title').textContent = i18n('system');
    document.getElementById('mh-sub').textContent   = 'openclaw system overview';
    document.getElementById('filters').style.display = 'none';
    document.getElementById('search-box').style.display = 'none';
    document.getElementById('sess-summary').style.display = 'none';
    const delBtn = document.getElementById('ss-del');
    if (delBtn) delBtn.remove();
    setConn('connected');
    loadSystem();
    S.systemTimer = setInterval(loadSystem, 30000);
  } else {
    const card = document.querySelector(`[data-session="${id}"]`);
    if (card) card.classList.add('active');
    const sess = S.sessions.find(s => s.id === id);

    document.getElementById('mh-title').textContent = id.substring(0,20) + '…';
    // subtitle: show all model names used in session
    const modelNames = sess?.models ? Object.keys(sess.models) : [];
    document.getElementById('mh-sub').textContent = sess
      ? (modelNames.length > 0 ? modelNames.join(' / ') : (sess.model || '—'))
      : '';
    document.getElementById('filters').style.display = 'none';
    document.getElementById('search-box').style.display = 'none';

    // show summary bar
    document.getElementById('sess-summary').style.display = '';
    document.getElementById('ss-id').textContent       = id;
    document.getElementById('ss-provider').textContent = sess?.provider || '—';
    document.getElementById('ss-model').textContent    = sess?.model || '—';
    document.getElementById('ss-msgs').textContent     = sess?.message_count || '—';
    const status = sess?.status || 'idle';
    document.getElementById('ss-status').textContent   = status === 'processing' ? i18n('processing') : i18n('idle');

    // total token usage
    const usage = sess?.usage;
    if (usage && usage.totalTokens > 0) {
      document.getElementById('ss-tokens').textContent = fmtTokens(usage.totalTokens);
      document.getElementById('ss-tokens').title =
        `${i18n('inputTokens')}: ${fmtTokens(usage.input)} | ${i18n('outputTokens')}: ${fmtTokens(usage.output)} | ${i18n('cacheTokens')}: ${fmtTokens(usage.cacheRead)}`;
      if (usage.cost > 0) {
        document.getElementById('ss-cost').textContent = '$' + usage.cost.toFixed(4);
      } else {
        document.getElementById('ss-cost').textContent = '—';
      }
    } else {
      document.getElementById('ss-tokens').textContent = '—';
      document.getElementById('ss-cost').textContent = '—';
    }

    // render per-model tags
    const modelsEl = document.getElementById('ss-models');
    const models = sess?.models || {};
    const modelKeys = Object.keys(models);
    if (modelKeys.length > 0) {
      modelsEl.innerHTML = modelKeys.map(m => {
        const u = models[m];
        const isCurrent = m === sess.model;
        const costStr = u.cost > 0 ? ` · $${u.cost.toFixed(4)}` : '';
        const detail = `${fmtTokens(u.totalTokens)}${costStr}`;
        const tooltip = `${i18n('inputTokens')}: ${fmtTokens(u.input)} | ${i18n('outputTokens')}: ${fmtTokens(u.output)} | ${i18n('cacheTokens')}: ${fmtTokens(u.cacheRead)}`;
        return `<span class="ss-model-tag${isCurrent?' current':''}" title="${tooltip}">` +
          `<span class="ss-model-name">${m}</span>` +
          `<span class="ss-model-detail">${detail}</span>` +
          `</span>`;
      }).join('');
    } else {
      modelsEl.innerHTML = `<span class="ss-model-tag current"><span class="ss-model-name">${sess?.model||'—'}</span></span>`;
    }

    // show delete button in top row
    let delBtn = document.getElementById('ss-del');
    if (!delBtn) {
      delBtn = document.createElement('button');
      delBtn.id = 'ss-del';
      delBtn.className = 'ss-del';
      document.querySelector('.ss-row-top').appendChild(delBtn);
    }
    delBtn.innerHTML = `<span class="icon" style="font-size:12px"><svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg></span> ${i18n('deleteSession')}`;
    delBtn.onclick = () => deleteSession(id);

    // mobile: update toggle info line and collapse by default
    const summaryEl = document.getElementById('sess-summary');
    summaryEl.classList.remove('ss-expanded');
    const statusTxt = (sess?.status === 'processing') ? i18n('processing') : i18n('idle');
    document.getElementById('ss-toggle-info').textContent =
      `${id.substring(0,8)}… · ${sess?.model||'—'} · ${statusTxt}`;

    startSession(id);
  }
}

/* ── SSE: live logs ─────────────────────────────────────── */
function startLive() {
  setConn('connecting');
  S.es = new EventSource('/api/logs/stream');

  S.es.addEventListener('log', e => {
    const d = JSON.parse(e.data);
    S.liveLogs.push(d);
    if (filterMatch(d.type, S.filter) && searchMatch(d.raw || '', S.searchQuery)) {
      appendLogRow(d);
    }
    document.getElementById('evt-cnt').textContent = S.liveLogs.length;
  });

  S.es.addEventListener('status', e => {
    const d = JSON.parse(e.data);
    appendLogRow({ type: d.type || 'warn', raw: d.message || '' });
  });

  S.es.onopen  = () => setConn('connected');
  S.es.onerror = () => {
    setConn('disconnected');
    setTimeout(() => { if (S.view==='live') startLive(); }, 3000);
  };
}

/* ── SSE: session detail ────────────────────────────────── */
function startSession(sid) {
  setConn('connecting');
  S.es = new EventSource(`/api/session/${sid}/stream`);

  S.es.addEventListener('session_event', e => {
    appendSessionBlock(JSON.parse(e.data), S.historyDone);
  });

  S.es.addEventListener('history_done', () => {
    S.historyDone = true;
    setConn('connected');
  });

  S.es.addEventListener('status', e => {
    const d = JSON.parse(e.data);
    if (d.type === 'error') {
      setConn('disconnected');
      document.getElementById('stream').innerHTML =
        `<div class="empty"><div class="ei" style="animation:none;border:none"><span class="icon" style="font-size:28px;color:var(--red)"><svg viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></span></div><p>${esc(d.message)}</p></div>`;
    }
  });

  S.es.onopen  = () => setConn('connecting');
  S.es.onerror = () => setConn('disconnected');
}

/* ═══════════════════════════════════════════════════════════
   RENDER: live log row
   ═══════════════════════════════════════════════════════════ */
function ensureLogHeader() {
  const stream = document.getElementById('stream');
  let header = stream.querySelector('.log-header');
  if (!header) {
    header = document.createElement('div');
    header.className = 'log-header';
    stream.insertBefore(header, stream.firstChild);
  }
  header.innerHTML = `<span>${i18n('time')}</span><span>${i18n('type')}</span><span>${i18n('content')}</span><span>${i18n('actions')}</span>`;
}

function appendLogRow(data) {
  const stream = document.getElementById('stream');
  rmEmpty(stream);
  ensureLogHeader();

  const t    = data.type || 'other';
  // Try to extract timestamp from data: timestamp, ts, time, @timestamp, or _meta.date
  const ts   = data.timestamp || data.ts || data.time || data['@timestamp'] || (data._meta && data._meta.date) || null;
  const time = fmtTime(ts);
  const rawText = data.raw || '';
  const row  = document.createElement('div');
  row.className = 'log-row';
  row.dataset.raw = rawText; // store raw text for search
  row.innerHTML =
    `<span class="lr-time">${time}</span>` +
    `<span class="lr-badge bt-${t}">${badgeLabel(t)}</span>` +
    `<span class="lr-msg">${linkSids(esc(rawText))}</span>` +
    `<div class="lr-actions"><button class="copy-btn" title="Copy log"><span class="icon icon-sm"><svg viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg></span></button></div>`;

  // Click to expand/collapse log row (but not on copy button)
  row.addEventListener('click', function(e) {
    // Don't toggle if clicking a link or copy button
    if (e.target.classList.contains('s-link') || e.target.classList.contains('copy-btn')) return;
    this.classList.toggle('expanded');
  });

  // Copy button handler
  const copyBtn = row.querySelector('.copy-btn');
  copyBtn.addEventListener('click', function(e) {
    e.stopPropagation();
    const text = rawText;  // Only copy log content (JSON), not timestamp
    const btn = this;

    // Try modern clipboard API first, fallback to execCommand
    const copySuccess = () => {
      btn.classList.add('copied');
      btn.innerHTML = '<span class="icon icon-sm"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></span>';
      showToast(i18n('copySuccess'));
      setTimeout(() => {
        btn.classList.remove('copied');
        btn.innerHTML = '<span class="icon icon-sm"><svg viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg></span>';
      }, 1500);
    };

    const copyFail = () => {
      showToast(i18n('copyFailed'), 'error');
    };

    if (navigator.clipboard && window.isSecureContext) {
      navigator.clipboard.writeText(text).then(copySuccess).catch(copyFail);
    } else {
      // Fallback for non-HTTPS
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      textarea.select();
      try {
        document.execCommand('copy');
        copySuccess();
      } catch (err) {
        copyFail();
      }
      document.body.removeChild(textarea);
    }
  });

  stream.appendChild(row);

  // keep DOM bounded
  const rows = stream.querySelectorAll('.log-row');
  if (rows.length > 600) {
    for (let i = 0; i < 100; i++) rows[i].remove();
    S.liveLogs = S.liveLogs.slice(-500);
  }

  if (S.autoScroll) stream.scrollTop = stream.scrollHeight;
}

/* ═══════════════════════════════════════════════════════════
   RENDER: session message block
   ═══════════════════════════════════════════════════════════ */
function appendSessionBlock(data, isLive) {
  const stream = document.getElementById('stream');
  rmEmpty(stream);

  const role   = data.role || 'unknown';
  const blocks = data.blocks || [];
  const div    = document.createElement('div');
  div.className = 'session-msg' + (isLive ? ' live' : '');

  let h = '';

  if (role === 'user') {
    h += `<div class="role-hdr rh-user"><span class="icon icon-sm"><svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></span> ${i18n('user')}</div>`;
    blocks.forEach(b => {
      if (b.type === 'text') h += `<div class="blk-user">
          <div class="user-hdr"><span class="icon icon-sm"><svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg></span> ${i18n('user')}</div>
          <div class="user-body">${esc(b.content)}</div>
        </div>`;
    });

  } else if (role === 'assistant') {
    h += `<div class="role-hdr rh-asst"><span class="icon icon-sm"><svg viewBox="0 0 24 24"><path d="M12 2a4 4 0 014 4v1h1a3 3 0 013 3v4a3 3 0 01-3 3h-1v1a4 4 0 01-8 0v-1H7a3 3 0 01-3-3v-4a3 3 0 013-3h1V6a4 4 0 014-4z"/><circle cx="9" cy="11" r="1" fill="currentColor"/><circle cx="15" cy="11" r="1" fill="currentColor"/></svg></span> ${i18n('assistant')}</div>`;
    blocks.forEach(b => {
      if (b.type === 'thinking') {
        h += `<div class="blk-think">
          <div class="think-hdr"><span class="icon icon-sm"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg></span> ${i18n('thinking')} <span style="color:var(--t3);font-size:10px">(${b.content.length} chars)</span></div>
          <div class="think-body"><pre>${esc(b.content)}</pre></div>
        </div>`;
      } else if (b.type === 'tool_call') {
        h += `<div class="blk-tcall">
          <div class="tcall-name"><span class="icon icon-sm"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg></span> ${esc(b.name)} <span class="tid">${esc(b.toolCallId||'')}</span></div>
          <div class="tcall-args">${hlJson(esc(JSON.stringify(b.arguments, null, 2)))}</div>
        </div>`;
      } else if (b.type === 'text') {
        h += `<div class="blk-text">
          <div class="text-hdr"><span class="icon icon-sm"><svg viewBox="0 0 24 24"><path d="M21 11.5a8.38 8.38 0 01-.9 3.8 8.5 8.5 0 01-7.6 4.7 8.38 8.38 0 01-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 01-.9-3.8 8.5 8.5 0 014.7-7.6 8.38 8.38 0 013.8-.9h.5a8.48 8.48 0 018 8v.5z"/></svg></span> ${i18n('response')}</div>
          <div class="text-body">${renderMd(b.content)}</div>
        </div>`;
      }
    });

  } else if (role === 'toolResult') {
    h += `<div class="role-hdr rh-tool"><span class="icon icon-sm"><svg viewBox="0 0 24 24"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg></span> ${i18n('toolResult')}</div>`;
    blocks.forEach(b => {
      if (b.type === 'tool_result') {
        const txt = typeof b.content === 'string' ? b.content : JSON.stringify(b.content, null, 2);
        h += `<div class="blk-tres"><pre>${esc(txt)}</pre></div>`;
      }
    });

  } else if (role === 'meta') {
    h += `<div class="role-hdr rh-meta"><span class="icon icon-sm"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg></span> ${i18n('meta')}</div>`;
    h += `<div class="blk-meta">${esc(JSON.stringify(data.meta || {}, null, 2))}</div>`;

  } else {
    h += `<div class="blk-meta">${esc(JSON.stringify(data))}</div>`;
  }

  div.innerHTML = h;
  stream.appendChild(div);
  if (S.autoScroll) stream.scrollTop = stream.scrollHeight;
}

/* ═══════════════════════════════════════════════════════════
   SYSTEM VIEW
   ═══════════════════════════════════════════════════════════ */
async function loadSystem() {
  const stream = document.getElementById('stream');
  if (!S.systemData) {
    stream.innerHTML = `<div class="empty"><div class="ei"></div><p>${i18n('sysLoading')}</p></div>`;
  }
  try {
    const data = await fetch('/api/system').then(r => r.json());
    S.systemData = data;
    renderSystem(data);
  } catch(e) {
    console.error('system load:', e);
    stream.innerHTML = `<div class="empty"><div class="ei" style="animation:none;border:none"><span class="icon" style="font-size:28px;color:var(--red)"><svg viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></span></div><p>${esc(e.message)}</p></div>`;
  }
}

function renderSystem(data) {
  const stream = document.getElementById('stream');
  const now = new Date().toLocaleTimeString('en-US', {hour12:false,hour:'2-digit',minute:'2-digit',second:'2-digit'});

  let h = '';

  // Toolbar
  h += `<div class="sys-toolbar">`;
  h += `<span class="sys-toolbar-left">${i18n('sysLastUpdate')}: ${now}</span>`;
  h += `<button class="sys-refresh-btn" onclick="loadSystem()"><span class="icon" style="font-size:12px"><svg viewBox="0 0 24 24"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg></span> ${i18n('sysRefresh')}</button>`;
  h += `</div>`;

  h += `<div class="sys-grid">`;

  // SVG icon helper
  const svgIcon = (d) => `<span class="icon icon-sm"><svg viewBox="0 0 24 24">${d}</svg></span>`;

  // 1. Channel Health
  h += sysCard(svgIcon('<path d="M1 1l22 22"/><path d="M16.72 11.06A10.94 10.94 0 0119 12.55"/><path d="M5 12.55a10.94 10.94 0 015.17-2.39"/><path d="M10.71 5.05A16 16 0 0122.56 9"/><path d="M1.42 9a15.91 15.91 0 014.7-2.88"/><path d="M8.53 16.11a6 6 0 016.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/>'), i18n('sysChannelHealth'), renderChannelHealth(data.channel_health));

  // 2. Diagnostics
  h += sysCard(svgIcon('<path d="M22 12h-4l-3 9L9 3l-3 9H2"/>'), i18n('sysDiagnostics'), renderDiagnostics(data.diagnostics));

  // 3. Presence
  h += sysCard(svgIcon('<path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/>'), i18n('sysPresence'), renderPresence(data.presence));

  // 4. Context Window
  h += sysCard(svgIcon('<rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/>'), i18n('sysContextWindow'), renderContextWindow(data.context_window));

  // 5. System Prompt Report
  h += sysCard(svgIcon('<path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/>'), i18n('sysPromptReport'), renderPromptReport(data.system_prompt_report));

  // 6. Skills Snapshot
  h += sysCard(svgIcon('<polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/>'), i18n('sysSkillsSnapshot'), renderSkillsSnapshot(data.skills_snapshot));

  // 7. Compaction History
  h += sysCard(svgIcon('<polyline points="21 8 21 21 3 21 3 8"/><rect x="1" y="3" width="22" height="5" rx="1"/><line x1="10" y1="12" x2="14" y2="12"/>'), i18n('sysCompaction'), renderCompaction(data.compaction_history));

  // 8. Devices
  h += sysCard(svgIcon('<rect x="5" y="2" width="14" height="20" rx="2"/><line x1="12" y1="18" x2="12.01" y2="18"/>'), i18n('sysDevices'), renderDevices(data.devices));

  // 9. Cron Jobs
  h += sysCard(svgIcon('<circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>'), i18n('sysCronJobs'), renderCronJobs(data.cron_jobs));

  // 10. Update Check
  h += sysCard(svgIcon('<polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>'), i18n('sysUpdateCheck'), renderUpdateCheck(data.update_check));

  // 11. Exec Approvals
  h += sysCard(svgIcon('<rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/>'), i18n('sysExecApprovals'), renderExecApprovals(data.exec_approvals));

  h += `</div>`; // .sys-grid

  stream.innerHTML = h;
}

function sysCard(icon, title, bodyHtml) {
  return `<div class="sys-card">
    <div class="sys-card-hdr"><span class="sys-icon">${icon}</span>${esc(title)}</div>
    <div class="sys-card-body">${bodyHtml}</div>
  </div>`;
}

function renderCliResult(data) {
  if (!data) return `<span class="sys-empty">${i18n('sysNoData')}</span>`;
  if (data.error) return `<span class="sys-badge-err">${esc(data.error)}</span>`;
  if (data.raw) return `<div class="sys-pre">${esc(data.raw)}</div>`;
  return `<div class="sys-pre">${esc(JSON.stringify(data, null, 2))}</div>`;
}

function renderChannelHealth(data) {
  if (!data) return `<span class="sys-empty">${i18n('sysNoData')}</span>`;
  if (data.error) return `<span class="sys-badge-err">${esc(data.error)}</span>`;
  if (data.raw) return `<div class="sys-pre">${esc(data.raw)}</div>`;

  let h = '';

  // Channel Summary
  if (data.channelSummary && Array.isArray(data.channelSummary)) {
    h += `<div class="sys-section-label">${esc(translateKey('channelSummary'))}</div>`;
    data.channelSummary.forEach(line => {
      const trimmed = (line || '').trim();
      if (!trimmed) return;
      const isConfigured = /configured/i.test(trimmed) && !/not configured/i.test(trimmed);
      const isNotConfigured = /not configured/i.test(trimmed);
      const isSub = trimmed.startsWith('-') || trimmed.startsWith('  ');
      if (isSub) {
        h += `<div class="sys-kv" style="padding-left:16px"><span class="sys-kv-key" style="color:var(--t3)">${esc(trimmed)}</span></div>`;
      } else {
        const badge = isConfigured ? `<span class="sys-badge-ok">${S.lang==='zh'?'已配置':'configured'}</span>`
                    : isNotConfigured ? `<span class="sys-badge-warn">${S.lang==='zh'?'未配置':'not configured'}</span>`
                    : '';
        const name = trimmed.split(':')[0] || trimmed;
        h += `<div class="sys-kv"><span class="sys-kv-key">${esc(name)}</span><span class="sys-kv-val">${badge}</span></div>`;
      }
    });
  }

  // Heartbeat
  if (data.heartbeat) {
    const hb = data.heartbeat;
    h += `<div class="sys-section-label">${esc(translateKey('heartbeat'))}</div>`;
    if (hb.defaultAgentId) h += `<div class="sys-kv"><span class="sys-kv-key">${esc(translateKey('defaultAgentId'))}</span><span class="sys-kv-val">${esc(hb.defaultAgentId)}</span></div>`;
    if (hb.agents && Array.isArray(hb.agents)) {
      hb.agents.forEach(a => {
        const st = a.enabled ? `<span class="sys-badge-ok">${S.lang==='zh'?'已启用':'enabled'}</span>` : `<span class="sys-badge-warn">${S.lang==='zh'?'已禁用':'disabled'}</span>`;
        h += `<div class="sys-kv"><span class="sys-kv-key">${esc(a.agentId || '—')}</span><span class="sys-kv-val">${st} &nbsp; ${esc(a.every || '')}</span></div>`;
      });
    }
  }

  // Gateway
  if (data.gateway) {
    const gw = data.gateway;
    h += `<div class="sys-section-label">${esc(translateKey('gateway'))}</div>`;
    const reachBadge = gw.reachable ? `<span class="sys-badge-ok">${S.lang==='zh'?'可达':'reachable'}</span>` : `<span class="sys-badge-err">${S.lang==='zh'?'不可达':'unreachable'}</span>`;
    h += `<div class="sys-kv"><span class="sys-kv-key">${esc(translateKey('status'))}</span><span class="sys-kv-val">${reachBadge}</span></div>`;
    if (gw.mode) h += `<div class="sys-kv"><span class="sys-kv-key">${esc(translateKey('mode'))}</span><span class="sys-kv-val">${esc(gw.mode)}</span></div>`;
    if (gw.url) h += `<div class="sys-kv"><span class="sys-kv-key">${esc(translateKey('url'))}</span><span class="sys-kv-val" style="font-size:10px">${esc(gw.url)}</span></div>`;
    if (gw.connectLatencyMs != null) h += `<div class="sys-kv"><span class="sys-kv-key">${esc(translateKey('connectLatencyMs'))}</span><span class="sys-kv-val">${gw.connectLatencyMs}ms</span></div>`;
    if (gw.self) {
      h += `<div class="sys-kv"><span class="sys-kv-key">${esc(translateKey('host'))}</span><span class="sys-kv-val">${esc(gw.self.host || '—')}</span></div>`;
      if (gw.self.ip) h += `<div class="sys-kv"><span class="sys-kv-key">${esc(translateKey('ip'))}</span><span class="sys-kv-val">${esc(gw.self.ip)}</span></div>`;
    }
    if (gw.error) h += `<div class="sys-kv"><span class="sys-kv-key">${esc(translateKey('error'))}</span><span class="sys-badge-err">${esc(String(gw.error))}</span></div>`;
  }

  // Gateway Service & Node Service
  [['gatewayService', data.gatewayService], ['nodeService', data.nodeService]].forEach(([key, svc]) => {
    if (!svc) return;
    h += `<div class="sys-section-label">${esc(translateKey(key))}</div>`;
    const isRunning = /running|active/i.test(svc.runtimeShort || '');
    const badge = isRunning ? `<span class="sys-badge-ok">${esc(svc.runtimeShort)}</span>` : `<span class="sys-badge-warn">${esc(svc.runtimeShort || svc.loadedText || '—')}</span>`;
    h += `<div class="sys-kv"><span class="sys-kv-key">${esc(translateKey('runtimeShort'))}</span><span class="sys-kv-val">${badge}</span></div>`;
    if (svc.label) h += `<div class="sys-kv"><span class="sys-kv-key">${esc(translateKey('type'))}</span><span class="sys-kv-val">${esc(svc.label)}</span></div>`;
  });

  // OS
  if (data.os) {
    h += `<div class="sys-section-label">${esc(translateKey('os'))}</div>`;
    h += `<div class="sys-kv"><span class="sys-kv-key">${esc(translateKey('label'))}</span><span class="sys-kv-val" style="font-size:10px">${esc(data.os.label || data.os.platform || '—')}</span></div>`;
  }

  // Update
  if (data.update) {
    h += `<div class="sys-section-label">${esc(translateKey('update'))}</div>`;
    if (data.update.installKind) h += `<div class="sys-kv"><span class="sys-kv-key">${esc(translateKey('installKind'))}</span><span class="sys-kv-val">${esc(data.update.installKind)}</span></div>`;
    if (data.update.packageManager) h += `<div class="sys-kv"><span class="sys-kv-key">${esc(translateKey('packageManager'))}</span><span class="sys-kv-val">${esc(data.update.packageManager)}</span></div>`;
    if (data.update.registry && data.update.registry.latestVersion) h += `<div class="sys-kv"><span class="sys-kv-key">${esc(translateKey('latestVersion'))}</span><span class="sys-kv-val"><span class="sys-tag">${esc(data.update.registry.latestVersion)}</span></span></div>`;
    if (data.update.deps) {
      const ds = data.update.deps;
      h += `<div class="sys-kv"><span class="sys-kv-key">${esc(translateKey('deps'))}</span><span class="sys-kv-val">${esc(ds.status || '—')}${ds.reason ? ' ('+esc(ds.reason)+')' : ''}</span></div>`;
    }
  }
  if (data.updateChannel) h += `<div class="sys-kv"><span class="sys-kv-key">${esc(translateKey('updateChannel'))}</span><span class="sys-kv-val"><span class="sys-tag">${esc(data.updateChannel)}</span></span></div>`;

  // Memory Plugin
  if (data.memoryPlugin) {
    h += `<div class="sys-section-label">${esc(translateKey('memoryPlugin'))}</div>`;
    const mEnabled = data.memoryPlugin.enabled ? `<span class="sys-badge-ok">${S.lang==='zh'?'已启用':'enabled'}</span>` : `<span class="sys-badge-warn">${S.lang==='zh'?'已禁用':'disabled'}</span>`;
    h += `<div class="sys-kv"><span class="sys-kv-key">${esc(translateKey('enabled'))}</span><span class="sys-kv-val">${mEnabled}</span></div>`;
    if (data.memoryPlugin.slot) h += `<div class="sys-kv"><span class="sys-kv-key">${esc(translateKey('slot'))}</span><span class="sys-kv-val">${esc(data.memoryPlugin.slot)}</span></div>`;
  }

  // Agents
  if (data.agents) {
    h += `<div class="sys-section-label">${esc(translateKey('agents'))}</div>`;
    h += `<div class="sys-kv"><span class="sys-kv-key">${esc(translateKey('totalSessions'))}</span><span class="sys-kv-val">${data.agents.totalSessions ?? '—'}</span></div>`;
    if (data.agents.agents && Array.isArray(data.agents.agents)) {
      data.agents.agents.forEach(a => {
        h += `<div class="sys-kv"><span class="sys-kv-key">${esc(translateKey('agentId'))}: ${esc(a.id)}</span><span class="sys-kv-val">${a.sessionsCount ?? 0} ${S.lang==='zh'?'个会话':'sessions'}</span></div>`;
      });
    }
  }

  // Security Audit
  if (data.securityAudit) {
    const sa = data.securityAudit;
    h += `<div class="sys-section-label">${esc(translateKey('securityAudit'))}</div>`;
    if (sa.summary) {
      const s = sa.summary;
      h += `<div style="display:flex;gap:6px;margin-bottom:6px">`;
      if (s.critical) h += `<span class="sys-badge-err">${S.lang==='zh'?'严重':'critical'}: ${s.critical}</span>`;
      if (s.warn) h += `<span class="sys-badge-warn">${S.lang==='zh'?'警告':'warn'}: ${s.warn}</span>`;
      if (s.info) h += `<span class="sys-badge-ok">${S.lang==='zh'?'信息':'info'}: ${s.info}</span>`;
      h += `</div>`;
    }
    if (sa.findings && Array.isArray(sa.findings)) {
      sa.findings.forEach(f => {
        const sevCls = f.severity === 'critical' ? 'err' : f.severity === 'warn' ? 'warn' : 'ok';
        h += `<div style="margin-bottom:4px"><div class="sys-kv"><span class="sys-kv-key" style="flex:1">${esc(f.title)}</span><span class="sys-badge-${sevCls}">${esc(f.severity)}</span></div>`;
        if (f.detail) h += `<div style="font-size:10px;color:var(--t3);padding:2px 0 0 4px;word-break:break-all">${esc(f.detail)}</div>`;
        if (f.remediation) h += `<div style="font-size:10px;color:var(--orange);padding:2px 0 0 4px">${esc(f.remediation)}</div>`;
        h += `</div>`;
      });
    }
  }

  // Sessions summary (count only)
  if (data.sessions) {
    h += `<div class="sys-section-label">${esc(translateKey('sessions'))}</div>`;
    h += `<div class="sys-kv"><span class="sys-kv-key">${esc(translateKey('count'))}</span><span class="sys-kv-val">${data.sessions.count ?? '—'}</span></div>`;
    if (data.sessions.defaults) {
      const d = data.sessions.defaults;
      if (d.model) h += `<div class="sys-kv"><span class="sys-kv-key">${esc(translateKey('model'))}</span><span class="sys-kv-val">${esc(d.model)}</span></div>`;
      if (d.contextTokens) h += `<div class="sys-kv"><span class="sys-kv-key">${esc(translateKey('contextTokens'))}</span><span class="sys-kv-val">${fmtTokens(d.contextTokens)}</span></div>`;
    }
  }

  return h || renderKvFromObj(data);
}

function renderDiagnostics(data) {
  if (!data) return `<span class="sys-empty">${i18n('sysNoData')}</span>`;
  if (data.error) return `<span class="sys-badge-err">${esc(data.error)}</span>`;
  if (data.raw) {
    const lines = data.raw.split('\n').filter(l => l.trim());
    if (lines.length > 0) {
      return lines.map(l => {
        const isPass = /✓|pass|ok/i.test(l);
        const isFail = /✕|✗|fail|error/i.test(l);
        const badge = isPass ? `<span class="sys-badge-ok">${S.lang==='zh'?'通过':'PASS'}</span>`
                    : isFail ? `<span class="sys-badge-err">${S.lang==='zh'?'失败':'FAIL'}</span>`
                    : '';
        return `<div class="sys-kv"><span class="sys-kv-key" style="flex:1">${esc(l.trim())}</span><span class="sys-kv-val">${badge}</span></div>`;
      }).join('');
    }
  }
  // File-based diagnostics: {issues: [...], issueCount: N}
  if (data.issues && Array.isArray(data.issues)) {
    if (data.issues.length === 0) {
      return `<div class="sys-kv"><span class="sys-kv-key" style="flex:1">${S.lang==='zh'?'未发现问题':'No issues found'}</span><span class="sys-badge-ok">${S.lang==='zh'?'正常':'OK'}</span></div>`;
    }
    let h = `<div class="sys-kv" style="margin-bottom:4px"><span class="sys-kv-key">${esc(translateKey('issueCount'))}</span><span class="sys-badge-warn">${data.issueCount}</span></div>`;
    data.issues.forEach(issue => {
      h += `<div class="sys-kv"><span class="sys-kv-key" style="flex:1;font-size:11px">${esc(issue)}</span><span class="sys-badge-warn">${S.lang==='zh'?'警告':'WARN'}</span></div>`;
    });
    return h;
  }
  return renderKvFromObj(data);
}

function renderPresence(data) {
  if (!data) return `<span class="sys-empty">${i18n('sysNoData')}</span>`;
  if (data.error) return `<span class="sys-badge-err">${esc(data.error)}</span>`;
  if (Array.isArray(data)) {
    if (data.length === 0) return `<span class="sys-empty">${i18n('sysNoData')}</span>`;
    return data.map(p => {
      let h = '';
      // Show text summary if available
      if (p.text) h += `<div style="font-size:11px;color:var(--t0);margin-bottom:4px;font-weight:600">${esc(p.text)}</div>`;
      // Primary fields
      const primary = ['host','ip','version','platform','mode','reason'];
      primary.forEach(k => {
        if (p[k] === undefined) return;
        let val = String(p[k]);
        // Add status badge for mode/reason
        if (k === 'mode') {
          const badge = p.mode === 'gateway' ? `<span class="sys-badge-ok">${esc(val)}</span>` : `<span class="sys-badge-warn">${esc(val)}</span>`;
          h += `<div class="sys-kv"><span class="sys-kv-key">${esc(translateKey(k))}</span><span class="sys-kv-val">${badge}</span></div>`;
        } else if (k === 'reason') {
          const badge = p.reason === 'self' ? `<span class="sys-badge-ok">${esc(val)}</span>` : `<span class="sys-badge-warn">${esc(val)}</span>`;
          h += `<div class="sys-kv"><span class="sys-kv-key">${esc(translateKey(k))}</span><span class="sys-kv-val">${badge}</span></div>`;
        } else {
          h += `<div class="sys-kv"><span class="sys-kv-key">${esc(translateKey(k))}</span><span class="sys-kv-val">${esc(val)}</span></div>`;
        }
      });
      // Secondary fields
      const secondary = ['deviceFamily','modelIdentifier','deviceId','instanceId'];
      secondary.forEach(k => {
        if (p[k] === undefined) return;
        h += `<div class="sys-kv"><span class="sys-kv-key">${esc(translateKey(k))}</span><span class="sys-kv-val" style="font-size:10px">${esc(String(p[k]))}</span></div>`;
      });
      // Roles & scopes as tags
      if (p.roles && Array.isArray(p.roles) && p.roles.length > 0) {
        h += `<div class="sys-kv"><span class="sys-kv-key">${esc(translateKey('roles'))}</span><span class="sys-kv-val">${p.roles.map(r => `<span class="sys-tag">${esc(r)}</span>`).join(' ')}</span></div>`;
      }
      if (p.scopes && Array.isArray(p.scopes) && p.scopes.length > 0) {
        h += `<div class="sys-kv"><span class="sys-kv-key">${esc(translateKey('scopes'))}</span><span class="sys-kv-val">${p.scopes.map(s => `<span class="sys-tag">${esc(s)}</span>`).join(' ')}</span></div>`;
      }
      // Timestamp
      if (p.ts) h += `<div class="sys-kv"><span class="sys-kv-key">${esc(translateKey('ts'))}</span><span class="sys-kv-val">${new Date(p.ts).toLocaleString()}</span></div>`;
      // Skip already rendered keys, render remaining
      const rendered = new Set([...primary, ...secondary, 'text', 'roles', 'scopes', 'ts']);
      Object.keys(p).forEach(k => { if (!rendered.has(k)) h += `<div class="sys-kv"><span class="sys-kv-key">${esc(translateKey(k))}</span><span class="sys-kv-val">${esc(String(p[k]))}</span></div>`; });
      return h;
    }).join('<hr style="border:none;border-top:1px solid var(--border);margin:6px 0">');
  }
  if (data.raw) return `<div class="sys-pre">${esc(data.raw)}</div>`;
  return renderKvFromObj(data);
}

function renderContextWindow(data) {
  if (!data || !Array.isArray(data) || data.length === 0) return `<span class="sys-empty">${i18n('sysNoData')}</span>`;
  return data.map(c => {
    const pct = c.percent != null ? c.percent : 0;
    const cls = pct > 90 ? 'err' : pct > 70 ? 'warn' : 'ok';
    const sid = (c.sessionId || '').substring(0,8) + '…';
    return `<div style="margin-bottom:8px">
      <div class="sys-kv" style="border:none"><span class="sys-kv-key">${sid}</span><span class="sys-kv-val">${pct != null ? pct + '%' : '—'}</span></div>
      <div class="sys-bar"><div class="sys-bar-fill ${cls}" style="width:${pct||0}%"></div></div>
      <div style="font-size:10px;color:var(--t3)">${S.lang==='zh'?'已用':'used'} ${fmtTokens(c.totalTokens||0)} / ${S.lang==='zh'?'总计':'total'} ${fmtTokens(c.contextTokens||0)}</div>
    </div>`;
  }).join('');
}

function renderPromptReport(data) {
  if (!data || !Array.isArray(data) || data.length === 0) return `<span class="sys-empty">${i18n('sysNoData')}</span>`;
  return data.map(r => {
    const sid = (r.sessionId || '').substring(0,8) + '…';
    const report = r.report;
    if (typeof report === 'string') return `<div><strong>${sid}</strong><div class="sys-pre">${esc(report)}</div></div>`;
    if (typeof report === 'object') {
      let h = `<div style="margin-bottom:6px"><strong style="color:var(--t0)">${sid}</strong></div>`;
      // Show key metrics in a structured way
      if (report.provider) h += `<div class="sys-kv"><span class="sys-kv-key">${esc(translateKey('provider'))}</span><span class="sys-kv-val">${esc(report.provider)}</span></div>`;
      if (report.model) h += `<div class="sys-kv"><span class="sys-kv-key">${esc(translateKey('model'))}</span><span class="sys-kv-val">${esc(report.model)}</span></div>`;
      if (report.sandbox) {
        const sbx = report.sandbox;
        h += `<div class="sys-kv"><span class="sys-kv-key">${esc(translateKey('sandbox'))}</span><span class="sys-kv-val">${sbx.sandboxed ? `<span class="sys-badge-ok">${esc(sbx.mode)}</span>` : `<span class="sys-badge-warn">${S.lang==='zh'?'关闭':'off'}</span>`}</span></div>`;
      }
      if (report.systemPrompt) {
        const sp = report.systemPrompt;
        h += `<div class="sys-kv"><span class="sys-kv-key">${esc(translateKey('systemPrompt'))}</span><span class="sys-kv-val">${sp.chars ?? '—'} ${S.lang==='zh'?'字符':'chars'}</span></div>`;
        if (sp.projectContextChars != null) h += `<div class="sys-kv" style="padding-left:8px"><span class="sys-kv-key" style="color:var(--t3)">${esc(translateKey('projectContextChars'))}</span><span class="sys-kv-val">${sp.projectContextChars}</span></div>`;
        if (sp.nonProjectContextChars != null) h += `<div class="sys-kv" style="padding-left:8px"><span class="sys-kv-key" style="color:var(--t3)">${esc(translateKey('nonProjectContextChars'))}</span><span class="sys-kv-val">${sp.nonProjectContextChars}</span></div>`;
      }
      // Workspace files
      if (report.injectedWorkspaceFiles && Array.isArray(report.injectedWorkspaceFiles)) {
        h += `<div class="sys-section-label">${esc(translateKey('injectedWorkspaceFiles'))}</div>`;
        report.injectedWorkspaceFiles.forEach(f => {
          const st = f.missing ? `<span class="sys-badge-warn">${S.lang==='zh'?'缺失':'missing'}</span>` : f.truncated ? `<span class="sys-badge-warn">${S.lang==='zh'?'已截断':'truncated'}</span>` : `<span class="sys-badge-ok">${f.injectedChars} ${S.lang==='zh'?'字符':'chars'}</span>`;
          h += `<div class="sys-kv"><span class="sys-kv-key">${esc(f.name)}</span><span class="sys-kv-val">${st}</span></div>`;
        });
      }
      // Skills summary
      if (report.skills && report.skills.entries) {
        h += `<div class="sys-section-label">${esc(translateKey('skills'))}</div>`;
        h += `<div style="display:flex;flex-wrap:wrap;gap:2px">`;
        report.skills.entries.forEach(s => { h += `<span class="sys-tag">${esc(s.name)}</span>`; });
        h += `</div>`;
      }
      // Tools summary
      if (report.tools && report.tools.entries) {
        h += `<div class="sys-section-label">${esc(translateKey('tools'))}</div>`;
        h += `<div style="display:flex;flex-wrap:wrap;gap:2px">`;
        report.tools.entries.forEach(t => { h += `<span class="sys-tag">${esc(t.name)}</span>`; });
        h += `</div>`;
      }
      return h;
    }
    return '';
  }).join('<hr style="border:none;border-top:1px solid var(--border);margin:6px 0">');
}

function renderSkillsSnapshot(data) {
  if (!data || !Array.isArray(data) || data.length === 0) return `<span class="sys-empty">${i18n('sysNoData')}</span>`;
  // Collect skills from all sessions
  let h = '';
  data.forEach(entry => {
    const snap = entry.snapshot;
    if (!snap) return;
    // snapshot may contain a 'prompt' with skill info, or be an object
    if (typeof snap === 'object' && snap.prompt) {
      // Extract skill names from the prompt text
      const matches = [...snap.prompt.matchAll(/<name>([^<]+)<\/name>/g)];
      if (matches.length > 0) {
        h += `<div style="display:flex;flex-wrap:wrap;gap:2px">`;
        matches.forEach(m => { h += `<span class="sys-tag">${esc(m[1])}</span>`; });
        h += `</div>`;
      } else {
        h += `<div class="sys-pre">${esc(snap.prompt.substring(0,500))}</div>`;
      }
    } else if (Array.isArray(snap)) {
      h += `<div style="display:flex;flex-wrap:wrap;gap:2px">`;
      snap.forEach(s => { h += `<span class="sys-tag">${esc(typeof s === 'string' ? s : s.name || JSON.stringify(s))}</span>`; });
      h += `</div>`;
    } else {
      h += renderKvFromObj(snap);
    }
  });
  return h || `<span class="sys-empty">${i18n('sysNoData')}</span>`;
}

function renderCompaction(data) {
  if (!data || !Array.isArray(data) || data.length === 0) return `<span class="sys-empty">${i18n('sysNoData')}</span>`;
  return data.map(c => {
    const sid = (c.sessionId || '').substring(0,8) + '…';
    const cnt = c.compactionCount || 0;
    return `<div class="sys-kv"><span class="sys-kv-key">${sid}</span><span class="sys-kv-val">${cnt} ${i18n('sysCompactions')}</span></div>`;
  }).join('');
}

function renderDevices(data) {
  if (!data) return `<span class="sys-empty">${i18n('sysNoData')}</span>`;
  let h = '';
  const paired = data.paired;
  const pending = data.pending;

  if (paired && typeof paired === 'object') {
    const devs = Object.values(paired);
    if (devs.length > 0) {
      h += `<div style="font-size:10px;font-weight:600;color:var(--t2);margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px">${i18n('sysPaired')} (${devs.length})</div>`;
      devs.forEach(d => {
        h += `<div style="margin-bottom:6px;padding:6px 0;border-bottom:1px solid var(--border)">`;
        if (d.platform) h += `<div class="sys-kv"><span class="sys-kv-key">${esc(translateKey('platform'))}</span><span class="sys-kv-val">${esc(d.platform)}</span></div>`;
        if (d.clientId) h += `<div class="sys-kv"><span class="sys-kv-key">${esc(translateKey('clientId'))}</span><span class="sys-kv-val">${esc(d.clientId)}</span></div>`;
        if (d.clientMode) h += `<div class="sys-kv"><span class="sys-kv-key">${esc(translateKey('clientMode'))}</span><span class="sys-kv-val">${esc(d.clientMode)}</span></div>`;
        if (d.role) h += `<div class="sys-kv"><span class="sys-kv-key">${esc(translateKey('role'))}</span><span class="sys-kv-val">${esc(d.role)}</span></div>`;
        if (d.roles && Array.isArray(d.roles)) h += `<div class="sys-kv"><span class="sys-kv-key">${esc(translateKey('roles'))}</span><span class="sys-kv-val">${d.roles.map(r => `<span class="sys-tag">${esc(r)}</span>`).join(' ')}</span></div>`;
        if (d.scopes && Array.isArray(d.scopes)) h += `<div class="sys-kv"><span class="sys-kv-key">${esc(translateKey('scopes'))}</span><span class="sys-kv-val">${d.scopes.map(s => `<span class="sys-tag">${esc(s)}</span>`).join(' ')}</span></div>`;
        if (d.tokens) {
          const tok = Object.values(d.tokens)[0];
          if (tok && tok.lastUsedAtMs) {
            h += `<div class="sys-kv"><span class="sys-kv-key">${esc(translateKey('lastUsedAtMs'))}</span><span class="sys-kv-val">${new Date(tok.lastUsedAtMs).toLocaleString()}</span></div>`;
          }
        }
        h += `</div>`;
      });
    } else {
      h += `<div style="font-size:10px;color:var(--t3)">${i18n('sysPaired')}: 0</div>`;
    }
  }

  if (pending && typeof pending === 'object') {
    const pkeys = Object.keys(pending);
    if (pkeys.length > 0) {
      h += `<div style="font-size:10px;font-weight:600;color:var(--orange);margin:6px 0 4px;text-transform:uppercase;letter-spacing:.5px">${i18n('sysPending')} (${pkeys.length})</div>`;
      pkeys.forEach(k => {
        h += `<div class="sys-kv"><span class="sys-kv-key">${esc(k.substring(0,12))}…</span><span class="sys-badge-warn">${i18n('sysPending')}</span></div>`;
      });
    }
  }

  return h || `<span class="sys-empty">${i18n('sysNoData')}</span>`;
}

function renderCronJobs(data) {
  if (!data) return `<span class="sys-empty">${i18n('sysNoData')}</span>`;
  const jobs = data.jobs;
  if (!jobs || !Array.isArray(jobs) || jobs.length === 0) return `<span class="sys-empty">${i18n('sysNoJobs')}</span>`;
  return jobs.map(j => {
    let h = '';
    Object.keys(j).forEach(k => {
      h += `<div class="sys-kv"><span class="sys-kv-key">${esc(translateKey(k))}</span><span class="sys-kv-val">${esc(String(j[k]))}</span></div>`;
    });
    return h;
  }).join('<hr style="border:none;border-top:1px solid var(--border);margin:6px 0">');
}

function renderUpdateCheck(data) {
  if (!data) return `<span class="sys-empty">${i18n('sysNoData')}</span>`;
  let h = '';
  if (data.lastNotifiedVersion) h += `<div class="sys-kv"><span class="sys-kv-key">${i18n('sysVersion')}</span><span class="sys-kv-val">${esc(data.lastNotifiedVersion)}</span></div>`;
  if (data.lastNotifiedTag) h += `<div class="sys-kv"><span class="sys-kv-key">${esc(translateKey('lastNotifiedTag'))}</span><span class="sys-kv-val"><span class="sys-tag">${esc(data.lastNotifiedTag)}</span></span></div>`;
  if (data.lastCheckedAt) h += `<div class="sys-kv"><span class="sys-kv-key">${i18n('sysLastChecked')}</span><span class="sys-kv-val">${new Date(data.lastCheckedAt).toLocaleString()}</span></div>`;
  return h || `<span class="sys-empty">${i18n('sysNoData')}</span>`;
}

function renderExecApprovals(data) {
  if (!data) return `<span class="sys-empty">${i18n('sysNoData')}</span>`;
  let h = '';
  if (data.version !== undefined) h += `<div class="sys-kv"><span class="sys-kv-key">${i18n('sysVersion')}</span><span class="sys-kv-val">${data.version}</span></div>`;
  if (data.socket) {
    h += `<div class="sys-kv"><span class="sys-kv-key">${i18n('sysSocket')}</span><span class="sys-kv-val" style="font-size:10px">${esc(data.socket.path || '—')}</span></div>`;
  }
  const agentCount = data.agents ? Object.keys(data.agents).length : 0;
  const defaultCount = data.defaults ? Object.keys(data.defaults).length : 0;
  h += `<div class="sys-kv"><span class="sys-kv-key">${esc(translateKey('agents'))}</span><span class="sys-kv-val">${agentCount}</span></div>`;
  h += `<div class="sys-kv"><span class="sys-kv-key">${esc(translateKey('defaults'))}</span><span class="sys-kv-val">${defaultCount}</span></div>`;
  return h;
}

function renderKvFromObj(obj) {
  if (!obj || typeof obj !== 'object') return `<span class="sys-empty">—</span>`;
  const keys = Object.keys(obj);
  if (keys.length === 0) return `<span class="sys-empty">—</span>`;
  return keys.map(k => {
    let v = obj[k];
    if (typeof v === 'object' && v !== null) v = JSON.stringify(v);
    return `<div class="sys-kv"><span class="sys-kv-key">${esc(translateKey(k))}</span><span class="sys-kv-val">${esc(String(v))}</span></div>`;
  }).join('');
}

/* ═══════════════════════════════════════════════════════════
   UTILITIES
   ═══════════════════════════════════════════════════════════ */
function closeES() { if (S.es) { S.es.close(); S.es = null; } }

function clearStream() {
  document.getElementById('stream').innerHTML =
    `<div class="empty"><div class="ei"></div><p>${i18n('connecting')}</p></div>`;
}

function setConn(st) {
  document.getElementById('conn-dot').className  = 'cd ' + st;
  document.getElementById('conn-label').textContent =
    st === 'connected' ? i18n('connected') : st === 'disconnected' ? i18n('disconnected') : i18n('connecting');
}

function rmEmpty(el) { const e = el.querySelector('.empty'); if (e) e.remove(); }

function filterMatch(type, f) {
  if (f === 'all') return true;
  const map = { queue:['enqueue','dequeue'], run:['run_start','run_done'],
                tool:['tool_start','tool_end'], session:['session_state'], error:['error','warn'] };
  return map[f] && map[f].includes(type);
}

function reRenderLive() {
  const stream = document.getElementById('stream');
  stream.innerHTML = '';
  S.liveLogs.forEach(d => {
    if (filterMatch(d.type, S.filter) && searchMatch(d.raw || '', S.searchQuery)) {
      appendLogRow(d);
    }
  });
}

function searchMatch(text, query) {
  if (!query) return true;
  return text.toLowerCase().includes(query.toLowerCase());
}

const BADGE_LABELS = {
  enqueue:'ENQ', dequeue:'DEQ',
  run_start:'RUN ▶', run_done:'RUN ✓',
  tool_start:'TOOL →', tool_end:'← TOOL',
  session_state:'SESSION', error:'ERROR', warn:'WARN', other:'OTHER'
};
function badgeLabel(t) { return BADGE_LABELS[t] || t.toUpperCase(); }

function fmtTime(ts) {
  // Use provided timestamp, fallback to current time
  let d;
  if (ts) {
    d = new Date(ts);
    if (isNaN(d.getTime())) d = new Date(); // invalid date fallback
  } else {
    d = new Date();
  }
  return d.toLocaleTimeString('en-US', { hour12:false, hour:'2-digit', minute:'2-digit', second:'2-digit' });
}

function esc(s) {
  return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

/* inline markdown renderer – no external dependency */
function renderMd(src) {
  src = String(src || '');
  var lines = src.split('\n');
  var html = '';
  var inCode = false, codeBuf = '', codeLang = '';
  var listStack = []; // track nested list depth

  function closeList() {
    while (listStack.length) { html += '</li></' + listStack.pop() + '>'; }
  }
  function inline(s) {
    s = esc(s);
    // images
    s = s.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img alt="$1" src="$2">');
    // links
    s = s.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
    // bold
    s = s.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    s = s.replace(/__(.+?)__/g, '<strong>$1</strong>');
    // italic
    s = s.replace(/\*(.+?)\*/g, '<em>$1</em>');
    s = s.replace(/_(.+?)_/g, '<em>$1</em>');
    // strikethrough
    s = s.replace(/~~(.+?)~~/g, '<del>$1</del>');
    // inline code
    s = s.replace(/`([^`]+)`/g, '<code>$1</code>');
    return s;
  }

  for (var i = 0; i < lines.length; i++) {
    var line = lines[i];

    // --- fenced code block toggle ---
    if (/^```/.test(line)) {
      if (inCode) {
        html += '<pre><code>' + esc(codeBuf) + '</code></pre>';
        codeBuf = ''; inCode = false;
      } else {
        closeList();
        codeLang = line.replace(/^```/, '').trim();
        inCode = true;
      }
      continue;
    }
    if (inCode) { codeBuf += (codeBuf ? '\n' : '') + line; continue; }

    // --- blank line ---
    if (!line.trim()) { closeList(); continue; }

    // --- heading ---
    var hm = line.match(/^(#{1,6})\s+(.+)/);
    if (hm) { closeList(); html += '<h'+hm[1].length+'>' + inline(hm[2]) + '</h'+hm[1].length+'>'; continue; }

    // --- hr ---
    if (/^[-*_]{3,}\s*$/.test(line)) { closeList(); html += '<hr>'; continue; }

    // --- blockquote ---
    if (/^>\s?/.test(line)) { closeList(); html += '<blockquote>' + inline(line.replace(/^>\s?/, '')) + '</blockquote>'; continue; }

    // --- table ---
    if (/^\|/.test(line) && /\|$/.test(line.trim())) {
      closeList();
      // collect all table lines
      var tLines = [];
      while (i < lines.length && /^\|/.test(lines[i]) && /\|$/.test(lines[i].trim())) {
        tLines.push(lines[i]); i++;
      }
      i--; // back up one
      if (tLines.length >= 2) {
        html += '<table>';
        // header
        var hCells = tLines[0].split('|').filter(function(c){return c.trim()!=='';});
        html += '<tr>' + hCells.map(function(c){return '<th>'+inline(c.trim())+'</th>';}).join('') + '</tr>';
        // skip separator row (index 1)
        for (var ti = 2; ti < tLines.length; ti++) {
          var cells = tLines[ti].split('|').filter(function(c){return c.trim()!=='';});
          html += '<tr>' + cells.map(function(c){return '<td>'+inline(c.trim())+'</td>';}).join('') + '</tr>';
        }
        html += '</table>';
      }
      continue;
    }

    // --- unordered list ---
    var ulm = line.match(/^(\s*)([-*+])\s+(.*)/);
    if (ulm) {
      var content = ulm[3];
      if (!listStack.length) { html += '<ul>'; listStack.push('ul'); }
      else { html += '</li>'; }
      html += '<li>' + inline(content);
      continue;
    }

    // --- ordered list ---
    var olm = line.match(/^(\s*)\d+\.\s+(.*)/);
    if (olm) {
      var content = olm[2];
      if (!listStack.length) { html += '<ol>'; listStack.push('ol'); }
      else { html += '</li>'; }
      html += '<li>' + inline(content);
      continue;
    }

    // --- paragraph ---
    closeList();
    html += '<p>' + inline(line) + '</p>';
  }

  // close any open blocks
  if (inCode) html += '<pre><code>' + esc(codeBuf) + '</code></pre>';
  closeList();
  return html;
}

/* format token count (e.g. 12345 → 12.3K) */
function fmtTokens(n) {
  if (!n || n === 0) return '0';
  if (n < 1000) return String(n);
  if (n < 1000000) return (n / 1000).toFixed(1) + 'K';
  return (n / 1000000).toFixed(2) + 'M';
}

/* format idle duration */
function fmtIdleTime(idleSince) {
  if (!idleSince) return i18n('idle');
  const now = Date.now() / 1000;
  const diff = now - idleSince;

  if (diff < 60) return i18n('justNow');
  if (diff < 3600) {
    const mins = Math.floor(diff / 60);
    return i18n('minutesAgo').replace('{0}', mins);
  }
  if (diff < 86400) {
    const hours = Math.floor(diff / 3600);
    return i18n('hoursAgo').replace('{0}', hours);
  }
  const days = Math.floor(diff / 86400);
  return i18n('daysAgo').replace('{0}', days);
}

/* make UUID session ids clickable in live log messages */
function linkSids(html) {
  return html.replace(/([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})/gi,
    '<span class="s-link" onclick="switchView(\'$1\')" title="Open session">$1</span>');
}

/* lightweight JSON syntax highlight on already-escaped text */
function hlJson(s) {
  return s
    .replace(/&quot;([^&]*?)&quot;\s*:/g, '<span class="jk">&quot;$1&quot;:</span>')
    .replace(/&quot;([^&]*?)&quot;/g,      '<span class="js">&quot;$1&quot;</span>')
    .replace(/\b(\d+\.?\d*)\b/g,          '<span class="jn">$1</span>')
    .replace(/\b(true|false|null)\b/g,    '<span class="jw">$1</span>');
}

/* ── bind UI events ───────────────────────────────────── */
function bindAll() {
  document.getElementById('btn-live').onclick = () => switchView('live');
  document.getElementById('btn-system').onclick = () => switchView('system');

  // mobile sidebar toggle
  document.getElementById('menu-btn').onclick = () => {
    const sidebar = document.querySelector('.sidebar');
    sidebar.classList.contains('open') ? closeSidebar() : openSidebar();
  };
  document.getElementById('sidebar-backdrop').onclick = closeSidebar;

  // mobile session summary toggle
  document.getElementById('ss-toggle').onclick = () => {
    document.getElementById('sess-summary').classList.toggle('ss-expanded');
  };

  // theme toggle
  document.getElementById('theme-btn').onclick = toggleTheme;

  // language toggle
  document.getElementById('lang-btn').onclick = toggleLang;

  // logout
  document.getElementById('logout-btn').onclick = () => {
    fetch('/api/logout').then(() => location.reload());
  };

  // search box
  const searchInput = document.getElementById('search-input');
  const searchClear = document.getElementById('search-clear');

  searchInput.addEventListener('input', function() {
    S.searchQuery = this.value;
    searchClear.classList.toggle('show', this.value.length > 0);
    if (S.view === 'live') reRenderLive();
  });

  searchClear.onclick = () => {
    searchInput.value = '';
    S.searchQuery = '';
    searchClear.classList.remove('show');
    if (S.view === 'live') reRenderLive();
  };

  // filter pills
  document.querySelectorAll('.fpill').forEach(btn => {
    btn.onclick = () => {
      S.filter = btn.dataset.f;
      document.querySelectorAll('.fpill').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      if (S.view === 'live') reRenderLive();
    };
  });

  // auto-scroll toggle
  document.getElementById('tog-scroll').onclick = function() {
    S.autoScroll = !S.autoScroll;
    localStorage.setItem('autoScroll', S.autoScroll);
    this.classList.toggle('on', S.autoScroll);
    if (S.autoScroll) { const el = document.getElementById('stream'); el.scrollTop = el.scrollHeight; }
  };

  // clear
  document.getElementById('btn-clr').onclick = () => {
    S.liveLogs = [];
    document.getElementById('evt-cnt').textContent = '0';
    document.getElementById('stream').innerHTML = '';
  };

  // scroll-to-top button
  const stream = document.getElementById('stream');
  const scrollTopBtn = document.getElementById('scroll-top-btn');
  stream.addEventListener('scroll', () => {
    scrollTopBtn.classList.toggle('show', stream.scrollTop > 200);
  });
  scrollTopBtn.onclick = () => {
    stream.scrollTo({ top: 0, behavior: 'smooth' });
  };
}
</script>
</body>
</html>
